---
import BaseLayout from '../../layouts/BaseLayout.astro';
import Breadcrumbs, { type BreadcrumbItem } from '../../components/Breadcrumbs.astro';
import CharacterHero from '../../components/CharacterHero.astro';
import DataPanel, { type DataPanelItem } from '../../components/DataPanel.astro';
import EntityList from '../../components/EntityList.astro';
import MarkdownDescription from '../../components/MarkdownDescription.astro';
import Section from '../../components/Section.astro';
import SectionHeader from '../../components/SectionHeader.astro';
import Tabs, { type TabItem } from '../../components/Tabs.astro';
import { getCardById, listCards } from '../../lib/content/cards';
import { getElementById } from '../../lib/content/elements';
import { getCharacterById } from '../../lib/content/characters';
import { getEventById } from '../../lib/content/events';
import { getPlaceById } from '../../lib/content/places';
import { getPlanetById } from '../../lib/content/planets';

export async function getStaticPaths() {
  const cards = await listCards();
  return cards.map((card) => ({
    params: { id: card.id },
  }));
}

const id = Astro.params.id;
const card = typeof id === 'string' ? await getCardById(id) : null;
const title = card ? card.name : 'Carta no encontrada';

type LinkView = { text: string; href?: string };

const parseWithPrefix = (value: string, prefix: string): string | null => {
  if (!value.startsWith(prefix)) {
    return null;
  }
  const idValue = value.slice(prefix.length);
  return idValue.length > 0 ? idValue : null;
};

const elements: LinkView[] = card
  ? await Promise.all(
      card.elements.map(async (entry) => {
        const elementId = parseWithPrefix(entry, 'element:');
        if (!elementId) {
          return { text: entry };
        }
        const element = await getElementById(elementId);
        if (!element) {
          return { text: `${elementId} (no encontrado)` };
        }
        return { text: element.name, href: `/elements/${element.id}` };
      }),
    )
  : [];

const represents: LinkView[] =
  card && card.represents.length > 0
    ? await Promise.all(
        card.represents.map(async (entry) => {
          const characterId = parseWithPrefix(entry, 'character:');
          if (characterId) {
            const character = await getCharacterById(characterId);
            if (!character) {
              return { text: `${characterId} (no encontrado)` };
            }
            return { text: character.name, href: `/characters/${character.id}` };
          }

          const eventId = parseWithPrefix(entry, 'event:');
          if (eventId) {
            const event = await getEventById(eventId);
            if (!event) {
              return { text: `${eventId} (no encontrado)` };
            }
            return { text: event.title, href: `/events/${event.id}` };
          }

          const placeId = parseWithPrefix(entry, 'place:');
          if (placeId) {
            const place = await getPlaceById(placeId);
            if (!place) {
              return { text: `${placeId} (no encontrado)` };
            }
            return { text: place.name, href: `/places/${place.id}` };
          }

          const planetId = parseWithPrefix(entry, 'planet:');
          if (planetId) {
            const planet = await getPlanetById(planetId);
            if (!planet) {
              return { text: `${planetId} (no encontrado)` };
            }
            return { text: planet.name, href: `/planets/${planet.id}` };
          }

          return { text: entry };
        }),
      )
    : [];

const breadcrumbs: BreadcrumbItem[] = card
  ? [
      { label: 'Inicio', href: '/' },
      { label: 'Cartas', href: '/cards' },
      { label: card.name, current: true },
    ]
  : [
      { label: 'Inicio', href: '/' },
      { label: 'Cartas', href: '/cards' },
      { label: 'Carta no encontrada', current: true },
    ];

const cardMeta = card ? [{ label: 'ID', value: `#${card.id}` }] : [];

const dataItems: DataPanelItem[] = [];
if (card) {
  dataItems.push({ label: 'Tipo', value: 'Carta de Artefacto', icon: 'style' });
}

const tabItems: TabItem[] = [
  { id: 'info', label: 'Información', icon: 'description' },
  { id: 'connections', label: 'Conexiones', icon: 'hub' },
];

const elementItems = elements.map(e => ({
  label: e.text,
  href: e.href
}));

const representsItems = represents.map(r => ({
  label: r.text,
  href: r.href
}));
---

<BaseLayout title={title} lang="es">
  {card ? (
    <div class="character-page">
      <Breadcrumbs items={breadcrumbs} />
      <CharacterHero
        name={card.name}
        meta={cardMeta}
        imageUrl={card.image ?? undefined}
      />

      <div class="character-page__grid">
        <aside class="character-page__sidebar">
          <DataPanel title="Datos de la carta" items={dataItems} />
        </aside>

        <div class="character-page__content">
          <Tabs items={tabItems} defaultTab="info">
            <div data-tab-panel="info" class="animate-fadeIn">
              <Section>
                <SectionHeader title="Descripción del Artefacto" showDivider />
                <MarkdownDescription content={card.body} />
              </Section>
            </div>

            <div data-tab-panel="connections" class="animate-fadeIn" hidden>
              <Section>
                <SectionHeader title="Elementos Afines" showDivider />
                {elementItems.length === 0 ? (
                  <p>No hay elementos asociados.</p>
                ) : (
                  <EntityList items={elementItems} />
                )}
              </Section>

              {representsItems.length > 0 ? (
                <Section>
                  <SectionHeader title="Representación" showDivider />
                  <EntityList items={representsItems} />
                </Section>
              ) : null}
            </div>
          </Tabs>
        </div>
      </div>
    </div>
  ) : (
    <div class="character-page">
      <Breadcrumbs items={breadcrumbs} />
      <CharacterHero name="Carta no encontrada" />
      <Section>
        <p>La carta solicitada no existe.</p>
        <p>
          <a href="/cards">Volver a cartas</a>
        </p>
      </Section>
    </div>
  )}
</BaseLayout>