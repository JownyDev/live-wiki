---
import BaseLayout from '../../../layouts/BaseLayout.astro';
import Breadcrumbs, { type BreadcrumbItem } from '../../../components/Breadcrumbs.astro';
import CharacterHero from '../../../components/CharacterHero.astro';
import CharacterList from '../../../components/CharacterList.astro';
import DataPanel, { type DataPanelItem } from '../../../components/DataPanel.astro';
import MarkdownDescription from '../../../components/MarkdownDescription.astro';
import Section from '../../../components/Section.astro';
import SectionHeader from '../../../components/SectionHeader.astro';
import Tabs, { type TabItem } from '../../../components/Tabs.astro';
import { type InlineMetaItem } from '../../../components/InlineMetaList.astro';
import { getEventById, listEvents } from '../../../lib/content/events';
import { getCharacterById } from '../../../lib/content/characters';
import { getPlaceById } from '../../../lib/content/places';
import { getPlanetById } from '../../../lib/content/planets';
import { parseLocationRef } from '../../../lib/content/location-refs';
import { formatEntityId } from '../../../lib/format';
import { languages } from '../../../i18n/ui';
import { useTranslations } from '../../../i18n/utils';
import { getRelativeLocaleUrl } from 'astro:i18n';

export async function getStaticPaths() {
  const events = await listEvents();
  const paths = [];
  for (const lang of Object.keys(languages)) {
    for (const event of events) {
      paths.push({ params: { lang, id: event.id } });
    }
  }
  return paths;
}

const { lang, id } = Astro.params;
const t = useTranslations(lang as any);
const eventId = typeof id === 'string' ? id : null;
const event = eventId ? await getEventById(eventId) : null;
const title = event ? event.title : t('event.not_found');

const breadcrumbs: BreadcrumbItem[] = event
  ? [
      { label: t('nav.home'), href: getRelativeLocaleUrl(lang as any, '/') },
      { label: t('nav.events'), href: getRelativeLocaleUrl(lang as any, '/events') },
      { label: event.title, current: true },
    ]
  : [
      { label: t('nav.home'), href: getRelativeLocaleUrl(lang as any, '/') },
      { label: t('nav.events'), href: getRelativeLocaleUrl(lang as any, '/events') },
      { label: t('event.not_found'), current: true },
    ];

const eventMeta: InlineMetaItem[] = event
  ? [{ label: 'ID', value: `#${event.id}` }]
  : [];

// Resolve Location for DataPanel
const resolveLocationView = async (locRef: string) => {
  const parsed = parseLocationRef(locRef);
  if (!parsed) return { text: locRef, icon: 'location-on' };

  if (parsed.kind === 'place') {
    const place = await getPlaceById(parsed.id);
    return {
      text: place?.name ?? formatEntityId(parsed.id),
      href: getRelativeLocaleUrl(lang as any, `/places/${parsed.id}`),
      icon: 'location-on'
    };
  }
  if (parsed.kind === 'planet') {
    const planet = await getPlanetById(parsed.id);
    return {
      text: planet?.name ?? formatEntityId(parsed.id),
      href: getRelativeLocaleUrl(lang as any, `/planets/${parsed.id}`),
      icon: 'public'
    };
  }
  return { text: formatEntityId(parsed.id), icon: 'location-on' };
};

const locationView = event?.location ? await resolveLocationView(event.location) : null;

const dataItems: DataPanelItem[] = [];
if (event) {
  if (locationView) {
    dataItems.push({
      label: t('ui.location') || 'UbicaciÃ³n',
      value: locationView.text,
      href: locationView.href,
      icon: locationView.icon as any || 'location-on'
    });
  }
}

// Resolve participants for CharacterList
const buildParticipants = async (participants: any[]) => {
  const items = [];
  for (const p of participants) {
    const char = await getCharacterById(p.character);
    if (char) {
      items.push({
        id: char.id,
        name: char.name,
        image: char.image,
        archetype: char.persona?.archetype,
        origin: char.origin,
        relationship: p.role, // Use role as relationship for display in relations variant
        href: getRelativeLocaleUrl(lang as any, `/characters/${char.id}`)
      });
    } else {
      items.push({
        id: p.character,
        name: p.character,
        relationship: p.role,
        missing: true
      });
    }
  }
  return items;
};

const participantItems = event ? await buildParticipants(event.who) : [];

const tabItems: TabItem[] = [
  { id: 'details', label: t('ui.details') || 'Detalles', icon: 'description' },
  { id: 'participants', label: t('ui.participants') || 'Participantes', icon: 'group' },
];
---

<BaseLayout title={title} lang={lang as any} pageClass="page--event">
  {event ? (
    <div class="event-page">
      <Breadcrumbs items={breadcrumbs} />
      <CharacterHero
        name={event.title}
        meta={eventMeta}
        imageUrl={event.image ?? undefined}
      />
      <div class="event-page__grid">
        <aside class="event-page__sidebar">
          <DataPanel title={t('ui.data_title')} items={dataItems} />
        </aside>
        <div class="event-page__content">
          <Tabs items={tabItems} defaultTab="details">
            <div data-tab-panel="details" class="animate-fadeIn">
              <Section>
                <SectionHeader title={t('ui.details') || 'Detalles'} showDivider />
                <MarkdownDescription content={event.body} />
              </Section>
            </div>

            <div data-tab-panel="participants" class="animate-fadeIn" hidden>
              <Section>
                <SectionHeader title={t('ui.participants') || 'Participantes'} showDivider />
                {participantItems.length > 0 ? (
                  <CharacterList characters={participantItems} />
                ) : (
                  <p>{t('ui.no_participants') || 'No hay participantes registrados.'}</p>
                )}
              </Section>
            </div>
          </Tabs>
        </div>
      </div>
    </div>
  ) : (
    <div class="event-page">
      <Breadcrumbs items={breadcrumbs} />
      <Section>
        <p>{t('event.not_found')}</p>
        <p>
          <a href={getRelativeLocaleUrl(lang as any, '/events')}>{t('event.back_to_list') || 'Volver a la lista'}</a>
        </p>
      </Section>
    </div>
  )}
</BaseLayout>
