---
import { readFile } from 'node:fs/promises';
import path from 'node:path';
import BaseLayout from '../../../layouts/BaseLayout.astro';
import Breadcrumbs, { type BreadcrumbItem } from '../../../components/Breadcrumbs.astro';
import CharacterHero from '../../../components/CharacterHero.astro';
import DataPanel, { type DataPanelItem } from '../../../components/DataPanel.astro';
import EventSummaryCard from '../../../components/EventSummaryCard.astro';
import MarkdownDescription from '../../../components/MarkdownDescription.astro';
import Section from '../../../components/Section.astro';
import SectionHeader from '../../../components/SectionHeader.astro';
import Tabs, { type TabItem } from '../../../components/Tabs.astro';
import EntityList from '../../../components/EntityList.astro';
import { getPlanetById, listPlanets } from '../../../lib/content/planets';
import { listEventsByPlanetId } from '../../../lib/content/events';
import { parseFrontmatter, getStringField } from '../../../lib/content/frontmatter';
import { parseLocationRef } from '../../../lib/content/location-refs';
import { listMarkdownFiles } from '../../../lib/content/markdown-files';

import { languages } from '../../../i18n/ui';
import { useTranslations } from '../../../i18n/utils';
import { getRelativeLocaleUrl } from 'astro:i18n';

export async function getStaticPaths() {
  const planets = await listPlanets();
  const paths = [];
  for (const lang of Object.keys(languages)) {
    for (const planet of planets) {
      paths.push({ params: { lang, id: planet.id } });
    }
  }
  return paths;
}

const { lang, id } = Astro.params;
const t = useTranslations(lang as any);
const planet = typeof id === 'string' ? await getPlanetById(id) : null;
const events =
  planet && typeof id === 'string' ? await listEventsByPlanetId(id) : [];

const places = await (async () => {
  if (!planet || typeof id !== 'string') {
    return [];
  }
  const placesDir = path.resolve(process.cwd(), 'content', 'places');
  const markdownFiles = await listMarkdownFiles(placesDir);
  const result: Array<{ id: string; name: string }> = [];

  for (const filename of markdownFiles) {
    const filePath = path.join(placesDir, filename);
    const markdown = await readFile(filePath, 'utf8');
    const { data } = parseFrontmatter(markdown);
    if (data.type !== 'place') {
      continue;
    }
    const placeId = getStringField(data, 'id');
    const name = getStringField(data, 'name');
    const planetValue = data.planetId;
    if (typeof planetValue !== 'string') {
      continue;
    }
    const parsed = parseLocationRef(planetValue);
    if (!parsed || parsed.kind !== 'planet' || parsed.id !== id) {
      continue;
    }
    result.push({ id: placeId, name });
  }

  result.sort((a, b) => a.name.localeCompare(b.name));
  return result;
})();

const title = planet ? planet.name : t('planet.not_found');

const breadcrumbs: BreadcrumbItem[] = planet
  ? [
      { label: t('nav.home'), href: getRelativeLocaleUrl(lang as any, '/') },
      { label: t('nav.planets'), href: getRelativeLocaleUrl(lang as any, '/planets') },
      { label: planet.name, current: true },
    ]
  : [
      { label: t('nav.home'), href: getRelativeLocaleUrl(lang as any, '/') },
      { label: t('nav.planets'), href: getRelativeLocaleUrl(lang as any, '/planets') },
      { label: t('planet.not_found'), current: true },
    ];

const dataItems: DataPanelItem[] = [];
if (planet) {
    dataItems.push({ label: t('ui.type'), value: t('ui.celestial_body'), icon: 'public' });
}

const tabItems: TabItem[] = [
  { id: 'info', label: t('ui.info'), icon: 'description' },
  { id: 'places', label: t('nav.places'), icon: 'location-on' },
  { id: 'events', label: t('ui.events'), icon: 'event' },
];

const placeItems = places.map(p => ({
  label: p.name,
  href: getRelativeLocaleUrl(lang as any, `/places/${p.id}`)
}));

const planetMeta = planet ? [{ label: 'ID', value: `#${planet.id}` }] : [];
---

<BaseLayout title={title} lang={lang as any}>
  {planet ? (
    <div class="character-page">
      <Breadcrumbs items={breadcrumbs} />
      <CharacterHero
        name={planet.name}
        meta={planetMeta}
        imageUrl={planet.image}
      />

      <div class="character-page__grid">
        <aside class="character-page__sidebar">
          <DataPanel title={t('ui.planet_data')} items={dataItems} />
        </aside>

        <div class="character-page__content">
          <Tabs items={tabItems} defaultTab="info">
            <div data-tab-panel="info" class="animate-fadeIn">
              <Section>
                <SectionHeader title={t('ui.description')} showDivider />
                <MarkdownDescription content={planet.body} />
              </Section>
            </div>

            <div data-tab-panel="places" class="animate-fadeIn" hidden>
              <Section>
                <SectionHeader title={t('ui.places_of_interest')} showDivider />
                {places.length === 0 ? (
                  <p>{t('place.list.empty')}</p>
                ) : (
                  <EntityList items={placeItems} />
                )}
              </Section>
            </div>

            <div data-tab-panel="events" class="animate-fadeIn" hidden>
              <Section>
                <SectionHeader title={t('planet.events_in_planet')} showDivider />
                {events.length === 0 ? (
                  <p>{t('event.list.empty')}</p>
                ) : (
                  <div class="relative space-y-16 py-8 before:content-[''] before:absolute before:left-1/2 before:top-0 before:-translate-x-1/2 before:w-px before:h-full before:bg-gradient-to-b before:from-transparent before:via-accent before:to-transparent before:opacity-30">
                    {events.map((event, index) => (
                      <EventSummaryCard
                        title={event.title}
                        date={event.date}
                        preview={event.preview}
                        href={getRelativeLocaleUrl(lang as any, `/events/${event.id}`)}
                        side={index % 2 === 0 ? 'right' : 'left'}
                      />
                    ))}
                  </div>
                )}
              </Section>
            </div>
          </Tabs>
        </div>
      </div>
    </div>
  ) : (
    <div class="character-page">
      <Breadcrumbs items={breadcrumbs} />
      <CharacterHero name={t('planet.not_found')} />
      <Section>
        <p>{t('planet.not_found')}</p>
        <p>
          <a href={getRelativeLocaleUrl(lang as any, '/planets')}>{t('planet.back_to_list')}</a>
        </p>
      </Section>
    </div>
  )}
</BaseLayout>
