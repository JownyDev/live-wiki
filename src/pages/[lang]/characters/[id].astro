---
import BaseLayout from '../../../layouts/BaseLayout.astro';
import Breadcrumbs, { type BreadcrumbItem } from '../../../components/Breadcrumbs.astro';
import CharacterHero from '../../../components/CharacterHero.astro';
import CharacterList from '../../../components/CharacterList.astro';
import DataPanel, { type DataPanelItem } from '../../../components/DataPanel.astro';
import EventSummaryCard from '../../../components/EventSummaryCard.astro';
import MarkdownDescription from '../../../components/MarkdownDescription.astro';
import EntityLink from '../../../components/EntityLink.astro';
import CapabilityCard from '../../../components/CapabilityCard.astro';
import EmotionsBaselineMood, {
  type BaselineMoodItem,
} from '../../../components/EmotionsBaselineMood.astro';
import EmotionsSensitivities from '../../../components/EmotionsSensitivities.astro';
import EmotionsTowardPlayer from '../../../components/EmotionsTowardPlayer.astro';
import GoalList from '../../../components/GoalList.astro';
import KnowledgeList from '../../../components/KnowledgeList.astro';
import KnowledgeSummary from '../../../components/KnowledgeSummary.astro';
import MemoryProvenancePolicy from '../../../components/MemoryProvenancePolicy.astro';
import MemoryRetrievalLimits from '../../../components/MemoryRetrievalLimits.astro';
import MemoryTags from '../../../components/MemoryTags.astro';
import PersonaArchetype from '../../../components/PersonaArchetype.astro';
import PersonaBiographyHighlights from '../../../components/PersonaBiographyHighlights.astro';
import PersonaTaboos from '../../../components/PersonaTaboos.astro';
import PersonaTraits from '../../../components/PersonaTraits.astro';
import PersonaValues from '../../../components/PersonaValues.astro';
import PersonaVoice from '../../../components/PersonaVoice.astro';
import PriorityList from '../../../components/PriorityList.astro';
import Section from '../../../components/Section.astro';
import SectionHeader from '../../../components/SectionHeader.astro';
import Tabs, { type TabItem } from '../../../components/Tabs.astro';
import { type InlineMetaItem } from '../../../components/InlineMetaList.astro';
import { getCharacterById, listCharacters } from '../../../lib/content/characters';
import { getElementById } from '../../../lib/content/elements';
import { getPlaceById } from '../../../lib/content/places';
import { getPlanetById } from '../../../lib/content/planets';
import { listEventsByCharacterId } from '../../../lib/content/events';
import { parseLocationRef } from '../../../lib/content/location-refs';
import { formatEntityId, formatOrigin } from '../../../lib/format';
import { languages } from '../../../i18n/ui';
import { useTranslations } from '../../../i18n/utils';
import { getRelativeLocaleUrl } from 'astro:i18n';

export async function getStaticPaths() {
  const characters = await listCharacters();
  const paths = [];
  for (const lang of Object.keys(languages)) {
    for (const character of characters) {
      paths.push({ params: { lang, id: character.id } });
    }
  }
  return paths;
}

const { lang, id } = Astro.params;
const t = useTranslations(lang as any);
const characterId = typeof id === 'string' ? id : null;
const character = characterId ? await getCharacterById(characterId) : null;
const events = characterId && character ? await listEventsByCharacterId(characterId) : [];
const title = character ? character.name : t('char.not_found');
const originView = await (async () => {
  if (!character?.origin) {
    return null;
  }
  const parsed = parseLocationRef(character.origin);
  if (!parsed) {
    return null;
  }
  switch (parsed.kind) {
    case 'place': {
      const place = await getPlaceById(parsed.id);
      return { text: place?.name ?? formatEntityId(parsed.id), href: `/places/${parsed.id}` };
    }
    case 'planet': {
      const planet = await getPlanetById(parsed.id);
      return { text: planet?.name ?? formatEntityId(parsed.id), href: `/planets/${parsed.id}` };
    }
    case 'space':
      return { text: formatEntityId(parsed.id) };
    case 'unknown':
      return { text: t('ui.unknown') };
  }
})();

type LinkView = { text: string; href?: string };
type RelationView = {
  id: string;
  name: string;
  image?: string;
  archetype?: string;
  origin?: string;
  relationship?: string;
  href?: string;
  missing?: boolean;
};
type RelatedGroup = { label: string; items: RelationView[] };

const hasItems = <T,>(items: readonly T[]): boolean => items.length > 0;
const hasText = (value: string | null | undefined): value is string =>
  typeof value === 'string' && value.length > 0;
const toTitleCase = (value: string): string =>
  value
    .split('_')
    .map((part) => part.charAt(0).toUpperCase() + part.slice(1))
    .join(' ');

const parseWithPrefix = (value: string, prefix: string): string | null => {
  if (!value.startsWith(prefix)) {
    return null;
  }
  const parsedId = value.slice(prefix.length);
  return parsedId.length > 0 ? parsedId : null;
};

const resolveAffinityView = async (value: string): Promise<LinkView> => {
  const elementId = parseWithPrefix(value, 'element:');
  if (!elementId) {
    return { text: value };
  }
  const element = await getElementById(elementId);
  return element
    ? { text: element.name, href: `/elements/${element.id}` }
    : { text: `${elementId} (${t('ui.unknown')})` };
};

const buildRelatedCharacters = async (
  entries: Array<{ type: string; character: string }>,
): Promise<RelationView[]> => {
  const items: RelationView[] = [];

  for (const entry of entries) {
    const label = entry.type;
    const characterId = parseWithPrefix(entry.character, 'character:');
    
    if (!characterId) {
      items.push({
        id: 'unknown',
        name: t('ui.unknown'),
        relationship: label,
        missing: true,
      });
      continue;
    }

    const relatedCharacter = await getCharacterById(characterId);
    if (!relatedCharacter) {
      items.push({
        id: characterId,
        name: t('ui.unknown'),
        relationship: label,
        missing: true,
      });
      continue;
    }

    items.push({
      id: relatedCharacter.id,
      name: relatedCharacter.name,
      image: relatedCharacter.image,
      archetype: relatedCharacter.persona?.archetype ?? undefined,
      origin: relatedCharacter.origin,
      relationship: label,
      href: getRelativeLocaleUrl(lang as any, `/characters/${relatedCharacter.id}`),
    });
  }

  return items;
};

const affinityView = character?.affinity
  ? await resolveAffinityView(character.affinity)
  : null;
const allRelatedCharacters = character ? await buildRelatedCharacters(character.relatedCharacters) : [];
const knowledge = character?.knowledge ?? null;
const knowledgeSummary = knowledge?.summary ?? null;
const knowledgeKnowsAbout = knowledge?.knowsAbout ?? [];
const knowledgeBlindspots = knowledge?.blindspots ?? [];
const knowledgeCanReveal = knowledge?.canReveal ?? [];
const hasKnowledge =
  hasText(knowledgeSummary) ||
  hasItems(knowledgeKnowsAbout) ||
  hasItems(knowledgeBlindspots) ||
  hasItems(knowledgeCanReveal);
const goals = character?.goals ?? null;
const goalsLongTerm = goals?.longTerm ?? [];
const goalsPriorities = goals?.typicalPriorities ?? [];
const hasGoals = hasItems(goalsLongTerm) || hasItems(goalsPriorities);
const capabilities = character?.capabilities ?? null;
const capabilityActions = capabilities?.actions ?? [];
const hasCapabilities = hasItems(capabilityActions);
const persona = character?.persona ?? null;
const personaVoice = persona?.voice ?? null;
const personaArchetype = persona?.archetype ?? null;
const personaVoiceTone = personaVoice?.tone ?? null;
const personaVoiceStyleNotes = personaVoice?.styleNotes ?? [];
const hasPersonaVoice = hasText(personaVoiceTone) || hasItems(personaVoiceStyleNotes);
const personaTraits = persona?.traits ?? [];
const personaValues = persona?.values ?? [];
const personaTaboos = persona?.taboos ?? [];
const personaHighlights = persona?.biographyHighlights ?? [];
const hasPersona =
  hasText(personaArchetype) ||
  hasItems(personaTraits) ||
  hasItems(personaValues) ||
  hasItems(personaTaboos) ||
  hasItems(personaHighlights) ||
  hasPersonaVoice;
const memoryProfile = character?.memoryProfile ?? null;
const memoryInterestTags = memoryProfile?.interestTags ?? [];
const memoryRelationshipTags = memoryProfile?.relationshipTags ?? [];
const memoryAllowedTags = memoryProfile?.allowedTags ?? [];
const memoryBlockedTags = memoryProfile?.blockedTags ?? [];
const hasMemoryTags = [
  memoryInterestTags,
  memoryRelationshipTags,
  memoryAllowedTags,
  memoryBlockedTags,
].some(hasItems);
const hasProvenancePolicy = Boolean(
  memoryProfile?.provenancePolicy &&
    hasItems(memoryProfile.provenancePolicy.allowed),
);
const hasRetrievalLimits = Boolean(
  memoryProfile?.retrievalLimits &&
    (memoryProfile.retrievalLimits.maxItems !== null ||
      memoryProfile.retrievalLimits.maxTokensSummary !== null),
);
const hasMemoryProfile = hasMemoryTags || hasProvenancePolicy || hasRetrievalLimits;
const emotionsProfile = character?.emotionsProfile ?? null;
const baselineMoodItems: BaselineMoodItem[] = emotionsProfile
  ? Object.entries(emotionsProfile.baselineMood).map(([key, value]) => ({
      label: toTitleCase(key),
      value,
      tone: key.toLowerCase(),
    }))
  : [];
const towardPlayer = emotionsProfile?.towardPlayer ?? null;
const towardPlayerStance = towardPlayer?.stance ?? null;
const towardPlayerNote = towardPlayer?.note ?? null;
const hasTowardPlayer = hasText(towardPlayerStance);
const sensitivities = emotionsProfile?.sensitivities ?? null;
const manipulability = emotionsProfile?.manipulability ?? null;
const hasSensitivities = Boolean(
  sensitivities &&
    (hasItems(sensitivities.angersIf) || hasItems(sensitivities.calmsIf)),
);
const hasManipulability = Boolean(
  manipulability &&
    (hasText(manipulability.byEmpathy) ||
      hasText(manipulability.byBribe) ||
      hasText(manipulability.byIntimidation) ||
      hasText(manipulability.byAuthority) ||
      hasItems(manipulability.notes)),
);
const hasEmotionsProfile =
  hasItems(baselineMoodItems) || hasTowardPlayer || hasSensitivities || hasManipulability;
const breadcrumbs: BreadcrumbItem[] = character
  ? [
      { label: t('nav.home'), href: getRelativeLocaleUrl(lang as any, '/') },
      { label: t('nav.characters'), href: getRelativeLocaleUrl(lang as any, '/characters') },
      { label: character.name, current: true },
    ]
  : [
      { label: t('nav.home'), href: getRelativeLocaleUrl(lang as any, '/') },
      { label: t('nav.characters'), href: getRelativeLocaleUrl(lang as any, '/characters') },
      { label: t('char.not_found'), current: true },
    ];
const characterMeta: InlineMetaItem[] = character
  ? [{ label: 'ID', value: `#${character.id}` }]
  : [];
const dataItems: DataPanelItem[] = [];

if (character?.born) {
  dataItems.push({ label: t('ui.born'), value: character.born, icon: 'cake' });
}

if (character?.died) {
  dataItems.push({ label: t('ui.died'), value: character.died, icon: 'heart_broken' });
}

if (originView) {
  dataItems.push({
    label: t('ui.origin'),
    value: originView.text,
    href: originView.href ? getRelativeLocaleUrl(lang as any, originView.href) : undefined,
    icon: 'location_on',
  });
}

if (affinityView) {
  dataItems.push({
    label: t('ui.affinity'),
    value: affinityView.text,
    href: affinityView.href ? getRelativeLocaleUrl(lang as any, affinityView.href) : undefined,
    icon: 'auto_awesome',
  });
}

const tabItems: TabItem[] = [
  { id: 'bio', label: t('ui.bio'), icon: 'description' },
  { id: 'technical', label: t('ui.technical'), icon: 'analytics' },
  { id: 'relations', label: t('ui.relations'), icon: 'group' },
  { id: 'events', label: t('ui.events'), icon: 'event' },
];
---

<BaseLayout title={title} lang={lang as any} pageClass="page--character">
  {character ? (
    <div class="character-page">
      <Breadcrumbs items={breadcrumbs} />
      <CharacterHero
        name={character.name}
        meta={characterMeta}
        imageUrl={character.image ?? undefined}
      />
      <div class="character-page__grid">
        <aside class="character-page__sidebar">
          <DataPanel title={t('ui.data_title')} items={dataItems} />
        </aside>
        <div class="character-page__content">
          <div class="character-tabs">
            <Tabs items={tabItems} defaultTab="bio">
            <div data-tab-panel="bio" class="animate-fadeIn">
              <Section>
                <SectionHeader title={t('ui.bio')} showDivider />
                <MarkdownDescription content={character.body} />
              </Section>
            </div>

            <div data-tab-panel="technical" class="animate-fadeIn" hidden>
              {hasPersona ? (
                <Section>
                  <SectionHeader title={t('char.persona')} showDivider />
                  <div class="character-page__persona">
                    {hasItems(personaTraits) ? (
                      <PersonaTraits items={personaTraits} />
                    ) : null}
                    {hasItems(personaValues) ? (
                      <PersonaValues items={personaValues} />
                    ) : null}
                    {hasText(personaArchetype) ? (
                      <PersonaArchetype archetype={personaArchetype} />
                    ) : null}
                    {hasPersonaVoice ? (
                      <PersonaVoice
                        tone={personaVoiceTone}
                        styleNotes={personaVoiceStyleNotes}
                      />
                    ) : null}
                    {hasItems(personaTaboos) ? (
                      <PersonaTaboos items={personaTaboos} />
                    ) : null}
                    {hasItems(personaHighlights) ? (
                      <PersonaBiographyHighlights items={personaHighlights} />
                    ) : null}
                  </div>
                </Section>
              ) : null}
              {hasKnowledge ? (
                <Section>
                  <SectionHeader title={t('char.knowledge')} showDivider />
                  <div class="character-page__knowledge">
                    {hasText(knowledgeSummary) ? (
                      <KnowledgeSummary summary={knowledgeSummary} />
                    ) : null}
                    {hasItems(knowledgeKnowsAbout) ? (
                      <KnowledgeList
                        label={t('char.knows_about')}
                        items={knowledgeKnowsAbout}
                        variant="knows"
                      />
                    ) : null}
                    {hasItems(knowledgeBlindspots) ? (
                      <KnowledgeList
                        label={t('char.blindspots')}
                        items={knowledgeBlindspots}
                        variant="blindspots"
                      />
                    ) : null}
                    {hasItems(knowledgeCanReveal) ? (
                      <KnowledgeList
                        label={t('char.can_reveal')}
                        items={knowledgeCanReveal}
                        variant="reveal"
                      />
                    ) : null}
                  </div>
                </Section>
              ) : null}
              {hasMemoryProfile ? (
                <Section>
                  <SectionHeader title={t('char.memory_profile')} showDivider />
                  <div class="character-page__memory">
                    {memoryProfile ? (
                      <MemoryTags
                        interestTags={memoryInterestTags}
                        relationshipTags={memoryRelationshipTags}
                        allowedTags={memoryAllowedTags}
                        blockedTags={memoryBlockedTags}
                      />
                    ) : null}
                    {hasProvenancePolicy || hasRetrievalLimits ? (
                      <div class="character-page__memory-grid">
                        {memoryProfile?.provenancePolicy && hasProvenancePolicy ? (
                          <MemoryProvenancePolicy
                            allowed={memoryProfile.provenancePolicy.allowed}
                            defaultValue={memoryProfile.provenancePolicy.default}
                          />
                        ) : null}
                        {memoryProfile?.retrievalLimits && hasRetrievalLimits ? (
                          <MemoryRetrievalLimits
                            maxItems={memoryProfile.retrievalLimits.maxItems}
                            maxTokensSummary={
                              memoryProfile.retrievalLimits.maxTokensSummary
                            }
                          />
                        ) : null}
                      </div>
                    ) : null}
                  </div>
                </Section>
              ) : null}
              {hasEmotionsProfile ? (
                <Section>
                  <SectionHeader title={t('char.emotions_profile')} showDivider />
                  <div class="character-page__emotions">
                    <div class="character-page__emotions-grid">
                      {hasItems(baselineMoodItems) ? (
                        <EmotionsBaselineMood items={baselineMoodItems} />
                      ) : null}
                      {hasTowardPlayer ? (
                        <EmotionsTowardPlayer
                          stance={towardPlayerStance}
                          note={towardPlayerNote}
                        />
                      ) : null}
                    </div>
                    {hasSensitivities || hasManipulability ? (
                      <EmotionsSensitivities
                        angersIf={sensitivities?.angersIf ?? []}
                        calmsIf={sensitivities?.calmsIf ?? []}
                        manipulability={manipulability}
                      />
                    ) : null}
                  </div>
                </Section>
              ) : null}
              {hasGoals ? (
                <Section>
                  <SectionHeader title={t('char.goals')} showDivider />
                  <div class="character-page__goals">
                    {hasItems(goalsLongTerm) ? (
                      <GoalList
                        label={t('char.long_term_goals')}
                        items={goalsLongTerm}
                        icon="flag"
                        itemIcon="ads_click"
                      />
                    ) : null}
                    {hasItems(goalsPriorities) ? (
                      <PriorityList
                        label={t('char.typical_priorities')}
                        items={goalsPriorities}
                        icon="list_alt"
                        itemIcon="priority_high"
                      />
                    ) : null}
                  </div>
                </Section>
              ) : null}
              {hasCapabilities ? (
                <Section>
                  <SectionHeader title={t('char.capabilities')} showDivider />
                  <div class="character-page__capabilities">
                    {capabilityActions.map((capability) => (
                      <CapabilityCard
                        action={capability.action}
                        triggers={capability.triggers}
                        notes={capability.notes}
                        filters={capability.filters}
                      />
                    ))}
                  </div>
                </Section>
              ) : null}
            </div>

            <div data-tab-panel="relations" class="animate-fadeIn" hidden>
              {allRelatedCharacters.length > 0 ? (
                <Section>
                  <SectionHeader title={t('ui.relations')} showDivider />
                  <div class="character-page__relations">
                    <CharacterList characters={allRelatedCharacters} variant="relations" />
                  </div>
                </Section>
              ) : (
                <p>{t('ui.no_relations')}</p>
              )}
            </div>

            <div data-tab-panel="events" class="animate-fadeIn" hidden>
              {events.length === 0 ? (
                <Section>
                   <SectionHeader title={t('ui.related_events')} showDivider />
                   <p>{t('event.list.empty')}</p>
                </Section>
              ) : (
                <Section>
                  <SectionHeader title={t('ui.related_events')} showDivider>
                    <a slot="action" href={getRelativeLocaleUrl(lang as any, '/events')}>
                      {t('event.full_timeline')}
                    </a>
                  </SectionHeader>
                  <div class="relative space-y-16 py-8 before:content-[''] before:absolute before:left-1/2 before:top-0 before:-translate-x-1/2 before:w-px before:h-full before:bg-gradient-to-b before:from-transparent before:via-accent before:to-transparent before:opacity-30">
                    {events.map((event, index) => (
                      <EventSummaryCard
                        title={event.title}
                        date={event.date}
                        preview={event.preview}
                        href={getRelativeLocaleUrl(lang as any, `/events/${event.id}`)}
                        side={index % 2 === 0 ? 'right' : 'left'}
                      />
                    ))}
                  </div>
                </Section>
              )}
            </div>
            </Tabs>
          </div>
        </div>
      </div>
    </div>
  ) : (
    <div class="character-page">
      <Breadcrumbs items={breadcrumbs} />
      <CharacterHero name={t('char.not_found')} />
      <Section>
        <p>{t('char.not_found')}</p>
        <p>
          <a href={getRelativeLocaleUrl(lang as any, '/characters')}>{t('char.back_to_list')}</a>
        </p>
      </Section>
    </div>
  )}
</BaseLayout>
