---
import BaseLayout from '../../layouts/BaseLayout.astro';
import Breadcrumbs, { type BreadcrumbItem } from '../../components/Breadcrumbs.astro';
import CharacterHero from '../../components/CharacterHero.astro';
import DataPanel, { type DataPanelItem } from '../../components/DataPanel.astro';
import EventSummaryCard from '../../components/EventSummaryCard.astro';
import MarkdownDescription from '../../components/MarkdownDescription.astro';
import EntityLink from '../../components/EntityLink.astro';
import CapabilityCard from '../../components/CapabilityCard.astro';
import EmotionsBaselineMood, {
  type BaselineMoodItem,
} from '../../components/EmotionsBaselineMood.astro';
import EmotionsSensitivities from '../../components/EmotionsSensitivities.astro';
import EmotionsTowardPlayer from '../../components/EmotionsTowardPlayer.astro';
import GoalList from '../../components/GoalList.astro';
import KnowledgeList from '../../components/KnowledgeList.astro';
import KnowledgeSummary from '../../components/KnowledgeSummary.astro';
import MemoryProvenancePolicy from '../../components/MemoryProvenancePolicy.astro';
import MemoryRetrievalLimits from '../../components/MemoryRetrievalLimits.astro';
import MemoryTags from '../../components/MemoryTags.astro';
import PersonaArchetype from '../../components/PersonaArchetype.astro';
import PersonaBiographyHighlights from '../../components/PersonaBiographyHighlights.astro';
import PersonaTaboos from '../../components/PersonaTaboos.astro';
import PersonaTraits from '../../components/PersonaTraits.astro';
import PersonaValues from '../../components/PersonaValues.astro';
import PersonaVoice from '../../components/PersonaVoice.astro';
import PriorityList from '../../components/PriorityList.astro';
import Section from '../../components/Section.astro';
import SectionHeader from '../../components/SectionHeader.astro';
import { type InlineMetaItem } from '../../components/InlineMetaList.astro';
import { getCharacterById, listCharacters } from '../../lib/content/characters';
import { getElementById } from '../../lib/content/elements';
import { listEventsByCharacterId } from '../../lib/content/events';
import { parseLocationRef } from '../../lib/content/location-refs';

export async function getStaticPaths() {
  const characters = await listCharacters();
  return characters.map((character) => ({
    params: { id: character.id },
  }));
}

const id = Astro.params.id;
const characterId = typeof id === 'string' ? id : null;
const character = characterId ? await getCharacterById(characterId) : null;
const events = characterId && character ? await listEventsByCharacterId(characterId) : [];
const title = character ? character.name : 'Personaje no encontrado';
const originView = (() => {
  if (!character?.origin) {
    return null;
  }
  const parsed = parseLocationRef(character.origin);
  if (!parsed) {
    return null;
  }
  switch (parsed.kind) {
    case 'place':
      return { text: parsed.id, href: `/places/${parsed.id}` };
    case 'planet':
      return { text: parsed.id, href: `/planets/${parsed.id}` };
    case 'space':
      return { text: parsed.id };
    case 'unknown':
      return { text: 'Desconocido' };
  }
})();

type LinkView = { text: string; href?: string };
type RelationView = LinkView & { missing?: boolean };
type RelatedGroup = { label: string; items: RelationView[] };

const hasItems = <T,>(items: readonly T[]): boolean => items.length > 0;
const hasText = (value: string | null | undefined): value is string =>
  typeof value === 'string' && value.length > 0;
const toTitleCase = (value: string): string =>
  value
    .split('_')
    .map((part) => part.charAt(0).toUpperCase() + part.slice(1))
    .join(' ');

const parseWithPrefix = (value: string, prefix: string): string | null => {
  if (!value.startsWith(prefix)) {
    return null;
  }
  const parsedId = value.slice(prefix.length);
  return parsedId.length > 0 ? parsedId : null;
};

const resolveAffinityView = async (value: string): Promise<LinkView> => {
  const elementId = parseWithPrefix(value, 'element:');
  if (!elementId) {
    return { text: value };
  }
  const element = await getElementById(elementId);
  return element
    ? { text: element.name, href: `/elements/${element.id}` }
    : { text: `${elementId} (no encontrado)` };
};

const buildRelatedGroups = async (
  entries: Array<{ type: string; character: string }>,
): Promise<RelatedGroup[]> => {
  const groups: RelatedGroup[] = [];
  const indexByLabel = new Map<string, number>();

  for (const entry of entries) {
    const label = entry.type;
    const existingIndex = indexByLabel.get(label);
    const groupIndex =
      typeof existingIndex === 'number'
        ? existingIndex
        : (() => {
            const nextIndex = groups.length;
            groups.push({ label, items: [] });
            indexByLabel.set(label, nextIndex);
            return nextIndex;
          })();

    const characterId = parseWithPrefix(entry.character, 'character:');
    if (!characterId) {
      groups[groupIndex].items.push({ text: 'missing', missing: true });
      continue;
    }
    const relatedCharacter = await getCharacterById(characterId);
    if (!relatedCharacter) {
      groups[groupIndex].items.push({ text: 'missing', missing: true });
      continue;
    }
    groups[groupIndex].items.push({
      text: relatedCharacter.name,
      href: `/characters/${relatedCharacter.id}`,
    });
  }

  return groups;
};

const affinityView = character?.affinity
  ? await resolveAffinityView(character.affinity)
  : null;
const relatedGroups = character ? await buildRelatedGroups(character.relatedCharacters) : [];
const knowledge = character?.knowledge ?? null;
const knowledgeSummary = knowledge?.summary ?? null;
const knowledgeKnowsAbout = knowledge?.knowsAbout ?? [];
const knowledgeBlindspots = knowledge?.blindspots ?? [];
const knowledgeCanReveal = knowledge?.canReveal ?? [];
const hasKnowledge =
  hasText(knowledgeSummary) ||
  hasItems(knowledgeKnowsAbout) ||
  hasItems(knowledgeBlindspots) ||
  hasItems(knowledgeCanReveal);
const goals = character?.goals ?? null;
const goalsLongTerm = goals?.longTerm ?? [];
const goalsPriorities = goals?.typicalPriorities ?? [];
const hasGoals = hasItems(goalsLongTerm) || hasItems(goalsPriorities);
const capabilities = character?.capabilities ?? null;
const capabilityActions = capabilities?.actions ?? [];
const hasCapabilities = hasItems(capabilityActions);
const persona = character?.persona ?? null;
const personaVoice = persona?.voice ?? null;
const personaArchetype = persona?.archetype ?? null;
const personaVoiceTone = personaVoice?.tone ?? null;
const personaVoiceStyleNotes = personaVoice?.styleNotes ?? [];
const hasPersonaVoice = hasText(personaVoiceTone) || hasItems(personaVoiceStyleNotes);
const personaTraits = persona?.traits ?? [];
const personaValues = persona?.values ?? [];
const personaTaboos = persona?.taboos ?? [];
const personaHighlights = persona?.biographyHighlights ?? [];
const hasPersona =
  hasText(personaArchetype) ||
  hasItems(personaTraits) ||
  hasItems(personaValues) ||
  hasItems(personaTaboos) ||
  hasItems(personaHighlights) ||
  hasPersonaVoice;
const memoryProfile = character?.memoryProfile ?? null;
const memoryInterestTags = memoryProfile?.interestTags ?? [];
const memoryRelationshipTags = memoryProfile?.relationshipTags ?? [];
const memoryAllowedTags = memoryProfile?.allowedTags ?? [];
const memoryBlockedTags = memoryProfile?.blockedTags ?? [];
const hasMemoryTags = [
  memoryInterestTags,
  memoryRelationshipTags,
  memoryAllowedTags,
  memoryBlockedTags,
].some(hasItems);
const hasProvenancePolicy = Boolean(
  memoryProfile?.provenancePolicy &&
    hasItems(memoryProfile.provenancePolicy.allowed),
);
const hasRetrievalLimits = Boolean(
  memoryProfile?.retrievalLimits &&
    (memoryProfile.retrievalLimits.maxItems !== null ||
      memoryProfile.retrievalLimits.maxTokensSummary !== null),
);
const hasMemoryProfile = hasMemoryTags || hasProvenancePolicy || hasRetrievalLimits;
const emotionsProfile = character?.emotionsProfile ?? null;
const baselineMoodItems: BaselineMoodItem[] = emotionsProfile
  ? Object.entries(emotionsProfile.baselineMood).map(([key, value]) => ({
      label: toTitleCase(key),
      value,
      tone: key.toLowerCase(),
    }))
  : [];
const towardPlayer = emotionsProfile?.towardPlayer ?? null;
const towardPlayerStance = towardPlayer?.stance ?? null;
const towardPlayerNote = towardPlayer?.note ?? null;
const hasTowardPlayer = hasText(towardPlayerStance);
const sensitivities = emotionsProfile?.sensitivities ?? null;
const manipulability = emotionsProfile?.manipulability ?? null;
const hasSensitivities = Boolean(
  sensitivities &&
    (hasItems(sensitivities.angersIf) || hasItems(sensitivities.calmsIf)),
);
const hasManipulability = Boolean(
  manipulability &&
    (hasText(manipulability.byEmpathy) ||
      hasText(manipulability.byBribe) ||
      hasText(manipulability.byIntimidation) ||
      hasText(manipulability.byAuthority) ||
      hasItems(manipulability.notes)),
);
const hasEmotionsProfile =
  hasItems(baselineMoodItems) || hasTowardPlayer || hasSensitivities || hasManipulability;
const breadcrumbs: BreadcrumbItem[] = character
  ? [
      { label: 'Inicio', href: '/' },
      { label: 'Personajes', href: '/characters' },
      { label: character.name, current: true },
    ]
  : [
      { label: 'Inicio', href: '/' },
      { label: 'Personajes', href: '/characters' },
      { label: 'Personaje no encontrado', current: true },
    ];
const characterMeta: InlineMetaItem[] = character
  ? [{ label: 'ID', value: `#${character.id}` }]
  : [];
const dataItems: DataPanelItem[] = [];

if (character?.born) {
  dataItems.push({ label: 'Nacimiento', value: character.born, icon: 'cake' });
}

if (character?.died) {
  dataItems.push({ label: 'Muerte', value: character.died, icon: 'heart_broken' });
}

if (originView) {
  dataItems.push({
    label: 'Origen',
    value: originView.text,
    href: originView.href,
    icon: 'location_on',
  });
}

if (affinityView) {
  dataItems.push({
    label: 'Afinidad',
    value: affinityView.text,
    href: affinityView.href,
    icon: 'auto_awesome',
  });
}
---

<BaseLayout title={title} lang="en" pageClass="page--character">
  {character ? (
    <div class="character-page">
      <Breadcrumbs items={breadcrumbs} />
      <CharacterHero
        name={character.name}
        meta={characterMeta}
        imageUrl={character.image ?? undefined}
      />
      <div class="character-page__grid">
        <aside class="character-page__sidebar">
          <DataPanel title="Datos del personaje" items={dataItems} />
        </aside>
        <div class="character-page__content">
          <Section>
            <SectionHeader title="BiografÃ­a" showDivider />
            <MarkdownDescription content={character.body} />
          </Section>
          {hasPersona ? (
            <Section>
              <SectionHeader title="Persona" showDivider />
              <div class="character-page__persona">
                {hasItems(personaTraits) ? (
                  <PersonaTraits items={personaTraits} />
                ) : null}
                {hasItems(personaValues) ? (
                  <PersonaValues items={personaValues} />
                ) : null}
                {hasText(personaArchetype) ? (
                  <PersonaArchetype archetype={personaArchetype} />
                ) : null}
                {hasPersonaVoice ? (
                  <PersonaVoice
                    tone={personaVoiceTone}
                    styleNotes={personaVoiceStyleNotes}
                  />
                ) : null}
                {hasItems(personaTaboos) ? (
                  <PersonaTaboos items={personaTaboos} />
                ) : null}
                {hasItems(personaHighlights) ? (
                  <PersonaBiographyHighlights items={personaHighlights} />
                ) : null}
              </div>
            </Section>
          ) : null}
          {hasKnowledge ? (
            <Section>
              <SectionHeader title="Knowledge" showDivider />
              <div class="character-page__knowledge">
                {hasText(knowledgeSummary) ? (
                  <KnowledgeSummary summary={knowledgeSummary} />
                ) : null}
                {hasItems(knowledgeKnowsAbout) ? (
                  <KnowledgeList
                    label="Knows About"
                    items={knowledgeKnowsAbout}
                    variant="knows"
                  />
                ) : null}
                {hasItems(knowledgeBlindspots) ? (
                  <KnowledgeList
                    label="Blindspots"
                    items={knowledgeBlindspots}
                    variant="blindspots"
                  />
                ) : null}
                {hasItems(knowledgeCanReveal) ? (
                  <KnowledgeList
                    label="Can Reveal"
                    items={knowledgeCanReveal}
                    variant="reveal"
                  />
                ) : null}
              </div>
            </Section>
          ) : null}
          {hasMemoryProfile ? (
            <Section>
              <SectionHeader title="Memory Profile" showDivider />
              <div class="character-page__memory">
                {memoryProfile ? (
                  <MemoryTags
                    interestTags={memoryInterestTags}
                    relationshipTags={memoryRelationshipTags}
                    allowedTags={memoryAllowedTags}
                    blockedTags={memoryBlockedTags}
                  />
                ) : null}
                {hasProvenancePolicy || hasRetrievalLimits ? (
                  <div class="character-page__memory-grid">
                    {memoryProfile?.provenancePolicy && hasProvenancePolicy ? (
                      <MemoryProvenancePolicy
                        allowed={memoryProfile.provenancePolicy.allowed}
                        defaultValue={memoryProfile.provenancePolicy.default}
                      />
                    ) : null}
                    {memoryProfile?.retrievalLimits && hasRetrievalLimits ? (
                      <MemoryRetrievalLimits
                        maxItems={memoryProfile.retrievalLimits.maxItems}
                        maxTokensSummary={
                          memoryProfile.retrievalLimits.maxTokensSummary
                        }
                      />
                    ) : null}
                  </div>
                ) : null}
              </div>
            </Section>
          ) : null}
          {hasEmotionsProfile ? (
            <Section>
              <SectionHeader title="Emotions Profile" showDivider />
              <div class="character-page__emotions">
                <div class="character-page__emotions-grid">
                  {hasItems(baselineMoodItems) ? (
                    <EmotionsBaselineMood items={baselineMoodItems} />
                  ) : null}
                  {hasTowardPlayer ? (
                    <EmotionsTowardPlayer
                      stance={towardPlayerStance}
                      note={towardPlayerNote}
                    />
                  ) : null}
                </div>
                {hasSensitivities || hasManipulability ? (
                  <EmotionsSensitivities
                    angersIf={sensitivities?.angersIf ?? []}
                    calmsIf={sensitivities?.calmsIf ?? []}
                    manipulability={manipulability}
                  />
                ) : null}
              </div>
            </Section>
          ) : null}
          {hasGoals ? (
            <Section>
              <SectionHeader title="Goals" showDivider />
              <div class="character-page__goals">
                {hasItems(goalsLongTerm) ? (
                  <GoalList
                    label="Long Term Goals"
                    items={goalsLongTerm}
                    icon="flag"
                    itemIcon="ads_click"
                  />
                ) : null}
                {hasItems(goalsPriorities) ? (
                  <PriorityList
                    label="Typical Priorities"
                    items={goalsPriorities}
                    icon="list_alt"
                    itemIcon="priority_high"
                  />
                ) : null}
              </div>
            </Section>
          ) : null}
          {hasCapabilities ? (
            <Section>
              <SectionHeader title="Capabilities" showDivider />
              <div class="character-page__capabilities">
                {capabilityActions.map((capability) => (
                  <CapabilityCard
                    action={capability.action}
                    triggers={capability.triggers}
                    notes={capability.notes}
                    filters={capability.filters}
                  />
                ))}
              </div>
            </Section>
          ) : null}
          {relatedGroups.length > 0 ? (
            <Section>
              <SectionHeader title="Relaciones" showDivider />
              <div class="character-page__relations">
                {relatedGroups.map((group) => (
                  <div class="character-page__relation-group">
                    <h3 class="character-page__relation-title">{group.label}</h3>
                    <ul class="character-page__relation-items tag-list">
                      {group.items.map((item) => (
                        <li>
                          <EntityLink
                            label={item.text}
                            href={item.href}
                            missing={item.missing}
                          />
                        </li>
                      ))}
                    </ul>
                  </div>
                ))}
              </div>
            </Section>
          ) : null}
          <Section>
            <SectionHeader title="Eventos relacionados" showDivider>
              <a slot="action" href="/events">
                Ver timeline
              </a>
            </SectionHeader>
            {events.length === 0 ? (
              <p>Sin eventos.</p>
            ) : (
              <div class="character-page__events">
                {events.map((event) => (
                  <EventSummaryCard
                    title={event.title}
                    date={event.date}
                    href={`/events/${event.id}`}
                  />
                ))}
              </div>
            )}
          </Section>
        </div>
      </div>
    </div>
  ) : (
    <div class="character-page">
      <Breadcrumbs items={breadcrumbs} />
      <CharacterHero name="Personaje no encontrado" />
      <Section>
        <p>El personaje solicitado no existe.</p>
        <p>
          <a href="/characters">Volver a personajes</a>
        </p>
      </Section>
    </div>
  )}
</BaseLayout>
