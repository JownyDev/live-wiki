---
import { getCharacterById, listCharacters } from '../../lib/content/characters';
import { listEventsByCharacterId } from '../../lib/content/events';
import { parseLocationRef } from '../../lib/content/location-refs';

export async function getStaticPaths() {
  const characters = await listCharacters();
  return characters.map((character) => ({
    params: { id: character.id },
  }));
}

const id = Astro.params.id;
const character = typeof id === 'string' ? await getCharacterById(id) : null;
const events =
  character && typeof id === 'string' ? await listEventsByCharacterId(id) : [];
const title = character ? character.name : 'Personaje no encontrado';
const originView = (() => {
  if (!character?.origin) {
    return { text: 'Sin origen' };
  }
  const parsed = parseLocationRef(character.origin);
  if (!parsed) {
    return { text: 'Sin origen' };
  }
  switch (parsed.kind) {
    case 'place':
      return { text: parsed.id, href: `/places/${parsed.id}` };
    case 'planet':
      return { text: parsed.id, href: `/planets/${parsed.id}` };
    case 'space':
      return { text: parsed.id };
    case 'unknown':
      return { text: 'Desconocido' };
  }
})();
---

<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width" />
    <title>{title}</title>
  </head>
  <body>
    <main>
      {character ? (
        <>
          <h1>{character.name}</h1>
          <section>
            <h2>Origen</h2>
            {originView.href ? (
              <a href={originView.href}>{originView.text}</a>
            ) : (
              <p>{originView.text}</p>
            )}
          </section>
          <div style="white-space: pre-wrap;">{character.body}</div>
          <section>
            <h2>Eventos</h2>
            {events.length === 0 ? (
              <p>Sin eventos.</p>
            ) : (
              <ul>
                {events.map((event) => (
                  <li>
                    <a href={`/events/${event.id}`}>{event.title}</a>
                    <span> ({event.date})</span>
                  </li>
                ))}
              </ul>
            )}
          </section>
        </>
      ) : (
        <>
          <h1>Personaje no encontrado</h1>
          <p>El personaje solicitado no existe.</p>
          <p>
            <a href="/characters">Volver a personajes</a>
          </p>
        </>
      )}
    </main>
  </body>
</html>
