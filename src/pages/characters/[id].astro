---
import BaseLayout from '../../layouts/BaseLayout.astro';
import Header from '../../components/Header.astro';
import MarkdownDescription from '../../components/MarkdownDescription.astro';
import RelationList, { type RelationItem } from '../../components/RelationList.astro';
import Section from '../../components/Section.astro';
import EntityLink from '../../components/EntityLink.astro';
import { getCharacterById, listCharacters } from '../../lib/content/characters';
import { listEventsByCharacterId } from '../../lib/content/events';
import { parseLocationRef } from '../../lib/content/location-refs';

export async function getStaticPaths() {
  const characters = await listCharacters();
  return characters.map((character) => ({
    params: { id: character.id },
  }));
}

const id = Astro.params.id;
const character = typeof id === 'string' ? await getCharacterById(id) : null;
const events =
  character && typeof id === 'string' ? await listEventsByCharacterId(id) : [];
const eventItems: RelationItem[] = events.map((event) => ({
  text: `${event.title} (${event.date})`,
  href: `/events/${event.id}`,
}));
const title = character ? character.name : 'Personaje no encontrado';
const originView = (() => {
  if (!character?.origin) {
    return { text: 'Sin origen' };
  }
  const parsed = parseLocationRef(character.origin);
  if (!parsed) {
    return { text: 'Sin origen' };
  }
  switch (parsed.kind) {
    case 'place':
      return { text: parsed.id, href: `/places/${parsed.id}` };
    case 'planet':
      return { text: parsed.id, href: `/planets/${parsed.id}` };
    case 'space':
      return { text: parsed.id };
    case 'unknown':
      return { text: 'Desconocido' };
  }
})();
---

<BaseLayout title={title} lang="en">
  {character ? (
    <>
      <Header title={character.name} />
      <Section title="Origen">
        {originView.href ? (
          <EntityLink href={originView.href} label={originView.text} />
        ) : (
          <p>{originView.text}</p>
        )}
      </Section>
      <MarkdownDescription content={character.body} />
      <Section>
        <RelationList label="Eventos" items={eventItems} emptyText="Sin eventos." />
      </Section>
    </>
  ) : (
    <>
      <Header title="Personaje no encontrado" />
      <Section>
        <p>El personaje solicitado no existe.</p>
        <p>
          <a href="/characters">Volver a personajes</a>
        </p>
      </Section>
    </>
  )}
</BaseLayout>
