---
import BaseLayout from '../../layouts/BaseLayout.astro';
import Breadcrumbs, { type BreadcrumbItem } from '../../components/Breadcrumbs.astro';
import CharacterHero from '../../components/CharacterHero.astro';
import DataPanel, { type DataPanelItem } from '../../components/DataPanel.astro';
import EventSummaryCard from '../../components/EventSummaryCard.astro';
import MarkdownDescription from '../../components/MarkdownDescription.astro';
import Section from '../../components/Section.astro';
import SectionHeader from '../../components/SectionHeader.astro';
import { type InlineMetaItem } from '../../components/InlineMetaList.astro';
import { getCharacterById, listCharacters } from '../../lib/content/characters';
import { listEventsByCharacterId } from '../../lib/content/events';
import { parseLocationRef } from '../../lib/content/location-refs';

export async function getStaticPaths() {
  const characters = await listCharacters();
  return characters.map((character) => ({
    params: { id: character.id },
  }));
}

const id = Astro.params.id;
const character = typeof id === 'string' ? await getCharacterById(id) : null;
const events =
  character && typeof id === 'string' ? await listEventsByCharacterId(id) : [];
const title = character ? character.name : 'Personaje no encontrado';
const originView = (() => {
  if (!character?.origin) {
    return { text: 'Sin origen' };
  }
  const parsed = parseLocationRef(character.origin);
  if (!parsed) {
    return { text: 'Sin origen' };
  }
  switch (parsed.kind) {
    case 'place':
      return { text: parsed.id, href: `/places/${parsed.id}` };
    case 'planet':
      return { text: parsed.id, href: `/planets/${parsed.id}` };
    case 'space':
      return { text: parsed.id };
    case 'unknown':
      return { text: 'Desconocido' };
  }
})();
const breadcrumbs: BreadcrumbItem[] = character
  ? [
      { label: 'Inicio', href: '/' },
      { label: 'Personajes', href: '/characters' },
      { label: character.name, current: true },
    ]
  : [
      { label: 'Inicio', href: '/' },
      { label: 'Personajes', href: '/characters' },
      { label: 'Personaje no encontrado', current: true },
    ];
const characterMeta: InlineMetaItem[] = character
  ? [{ label: 'ID', value: `#${character.id}` }]
  : [];
const dataItems: DataPanelItem[] = character
  ? [
      {
        label: 'Origen',
        value: originView.text,
        href: originView.href,
      },
    ]
  : [];
---

<BaseLayout title={title} lang="en" pageClass="page--character">
  {character ? (
    <div class="character-page">
      <Breadcrumbs items={breadcrumbs} />
      <CharacterHero name={character.name} meta={characterMeta} />
      <div class="character-page__grid">
        <aside class="character-page__sidebar">
          <DataPanel title="Datos del personaje" items={dataItems} />
        </aside>
        <div class="character-page__content">
          <Section>
            <SectionHeader title="BiografÃ­a" showDivider />
            <MarkdownDescription content={character.body} />
          </Section>
          <Section>
            <SectionHeader title="Eventos relacionados" showDivider>
              <a slot="action" href="/events">
                Ver timeline
              </a>
            </SectionHeader>
            {events.length === 0 ? (
              <p>Sin eventos.</p>
            ) : (
              <div class="character-page__events">
                {events.map((event) => (
                  <EventSummaryCard
                    title={event.title}
                    date={event.date}
                    href={`/events/${event.id}`}
                  />
                ))}
              </div>
            )}
          </Section>
        </div>
      </div>
    </div>
  ) : (
    <div class="character-page">
      <Breadcrumbs items={breadcrumbs} />
      <CharacterHero name="Personaje no encontrado" />
      <Section>
        <p>El personaje solicitado no existe.</p>
        <p>
          <a href="/characters">Volver a personajes</a>
        </p>
      </Section>
    </div>
  )}
</BaseLayout>
