---
import { readFile } from 'node:fs/promises';
import path from 'node:path';
import BaseLayout from '../../layouts/BaseLayout.astro';
import Header from '../../components/Header.astro';
import MarkdownDescription from '../../components/MarkdownDescription.astro';
import RelationList, { type RelationItem } from '../../components/RelationList.astro';
import Section from '../../components/Section.astro';
import { getPlanetById, listPlanets } from '../../lib/content/planets';
import { listEventsByPlanetId } from '../../lib/content/events';
import { parseFrontmatter, getStringField } from '../../lib/content/frontmatter';
import { parseLocationRef } from '../../lib/content/location-refs';
import { listMarkdownFiles } from '../../lib/content/markdown-files';

export async function getStaticPaths() {
  const planets = await listPlanets();
  return planets.map((planet) => ({
    params: { id: planet.id },
  }));
}

const id = Astro.params.id;
const planet = typeof id === 'string' ? await getPlanetById(id) : null;
const events =
  planet && typeof id === 'string' ? await listEventsByPlanetId(id) : [];
const places = await (async () => {
  if (!planet || typeof id !== 'string') {
    return [];
  }
  // Leemos frontmatter directo para evitar una query nueva fuera de este wiring UI.
  const placesDir = path.resolve(process.cwd(), 'content', 'places');
  const markdownFiles = await listMarkdownFiles(placesDir);
  const result: Array<{ id: string; name: string }> = [];

  for (const filename of markdownFiles) {
    const filePath = path.join(placesDir, filename);
    const markdown = await readFile(filePath, 'utf8');
    const { data } = parseFrontmatter(markdown);
    if (data.type !== 'place') {
      continue;
    }
    const placeId = getStringField(data, 'id');
    const name = getStringField(data, 'name');
    const planetValue = data.planetId;
    if (typeof planetValue !== 'string') {
      continue;
    }
    const parsed = parseLocationRef(planetValue);
    if (!parsed || parsed.kind !== 'planet' || parsed.id !== id) {
      continue;
    }
    result.push({ id: placeId, name });
  }

  result.sort((a, b) => a.name.localeCompare(b.name));
  return result;
})();
const title = planet ? planet.name : 'Planeta no encontrado';
const placeItems: RelationItem[] = places.map((place) => ({
  text: place.name,
  href: `/places/${place.id}`,
}));
const eventItems: RelationItem[] = events.map((event) => ({
  text: `${event.title} (${event.date})`,
  href: `/events/${event.id}`,
}));
---

<BaseLayout title={title}>
  {planet ? (
    <>
      <Header title={planet.name} />
      <Section>
        <RelationList label="Lugares" items={placeItems} emptyText="Sin lugares." />
      </Section>
      <Section>
        <RelationList
          label="Eventos en el planeta"
          items={eventItems}
          emptyText="Sin eventos."
        />
      </Section>
      <MarkdownDescription content={planet.body} />
    </>
  ) : (
    <>
      <Header title="Planeta no encontrado" />
      <Section>
        <p>El planeta solicitado no existe.</p>
        <p>
          <a href="/planets">Volver a planetas</a>
        </p>
      </Section>
    </>
  )}
</BaseLayout>
