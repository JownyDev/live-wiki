---
import { readFile } from 'node:fs/promises';
import path from 'node:path';
import { getPlanetById, listPlanets } from '../../lib/content/planets';
import { listEventsByPlanetId } from '../../lib/content/events';
import { parseFrontmatter, getStringField } from '../../lib/content/frontmatter';
import { parseLocationRef } from '../../lib/content/location-refs';
import { listMarkdownFiles } from '../../lib/content/markdown-files';

export async function getStaticPaths() {
  const planets = await listPlanets();
  return planets.map((planet) => ({
    params: { id: planet.id },
  }));
}

const id = Astro.params.id;
const planet = typeof id === 'string' ? await getPlanetById(id) : null;
const events =
  planet && typeof id === 'string' ? await listEventsByPlanetId(id) : [];
const places = await (async () => {
  if (!planet || typeof id !== 'string') {
    return [];
  }
  // Leemos frontmatter directo para evitar una query nueva fuera de este wiring UI.
  const placesDir = path.resolve(process.cwd(), 'content', 'places');
  const markdownFiles = await listMarkdownFiles(placesDir);
  const result: Array<{ id: string; name: string }> = [];

  for (const filename of markdownFiles) {
    const filePath = path.join(placesDir, filename);
    const markdown = await readFile(filePath, 'utf8');
    const { data } = parseFrontmatter(markdown);
    if (data.type !== 'place') {
      continue;
    }
    const placeId = getStringField(data, 'id');
    const name = getStringField(data, 'name');
    const planetValue = data.planetId;
    if (typeof planetValue !== 'string') {
      continue;
    }
    const parsed = parseLocationRef(planetValue);
    if (!parsed || parsed.kind !== 'planet' || parsed.id !== id) {
      continue;
    }
    result.push({ id: placeId, name });
  }

  result.sort((a, b) => a.name.localeCompare(b.name));
  return result;
})();
const title = planet ? planet.name : 'Planeta no encontrado';
---

<html lang="es">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width" />
    <title>{title}</title>
  </head>
  <body>
    <main>
      {planet ? (
        <>
          <h1>{planet.name}</h1>
          <section>
            <h2>Lugares</h2>
            {places.length === 0 ? (
              <p>Sin lugares.</p>
            ) : (
              <ul>
                {places.map((place) => (
                  <li>
                    <a href={`/places/${place.id}`}>{place.name}</a>
                  </li>
                ))}
              </ul>
            )}
          </section>
          <section>
            <h2>Eventos en el planeta</h2>
            {events.length === 0 ? (
              <p>Sin eventos.</p>
            ) : (
              <ul>
                {events.map((event) => (
                  <li>
                    <a href={`/events/${event.id}`}>{event.title}</a>
                    <span> ({event.date})</span>
                  </li>
                ))}
              </ul>
            )}
          </section>
          <div style="white-space: pre-wrap;">{planet.body}</div>
        </>
      ) : (
        <>
          <h1>Planeta no encontrado</h1>
          <p>El planeta solicitado no existe.</p>
          <p>
            <a href="/planets">Volver a planetas</a>
          </p>
        </>
      )}
    </main>
  </body>
</html>
