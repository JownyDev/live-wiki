---
import { getEventById, listEvents } from '../../lib/content/events';
import { getCharacterById } from '../../lib/content/characters';

export async function getStaticPaths() {
  const events = await listEvents();
  return events.map((event) => ({
    params: { id: event.id },
  }));
}

const id = Astro.params.id;
const event = typeof id === 'string' ? await getEventById(id) : null;
const title = event ? event.title : 'Evento no encontrado';

type Participant = { id: string; name: string | null };

const parseCharacterId = (entry: string): string | null => {
  const prefix = 'character:';
  if (!entry.startsWith(prefix)) {
    return null;
  }
  const characterId = entry.slice(prefix.length).trim();
  return characterId.length > 0 ? characterId : null;
};

const participants: Participant[] = event
  ? (
      await Promise.all(
        event.who
          .map(parseCharacterId)
          .filter((characterId): characterId is string => characterId !== null)
          .map(async (characterId) => {
            const character = await getCharacterById(characterId);
            return {
              id: characterId,
              name: character ? character.name : null,
            };
          }),
      )
    ).filter(
      (participant, index, all) =>
        all.findIndex((entry) => entry.id === participant.id) === index,
    )
  : [];
---

<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width" />
    <title>{title}</title>
  </head>
  <body>
    <main>
      {event ? (
        <>
          <h1>{event.title}</h1>
          <p>{event.date}</p>
          <div style="white-space: pre-wrap;">{event.body}</div>
          <section>
            <h2>Participantes</h2>
            {participants.length === 0 ? (
              <p>Sin participantes.</p>
            ) : (
              <ul>
                {participants.map((participant) => (
                  <li>
                    {participant.name ? (
                      <a href={`/characters/${participant.id}`}>{participant.name}</a>
                    ) : (
                      <span>{participant.id} (no encontrado)</span>
                    )}
                  </li>
                ))}
              </ul>
            )}
          </section>
        </>
      ) : (
        <>
          <h1>Evento no encontrado</h1>
          <p>El evento solicitado no existe.</p>
          <p>
            <a href="/events">Volver a eventos</a>
          </p>
        </>
      )}
    </main>
  </body>
</html>
