---
import { getEventById, listEvents } from '../../lib/content/events';
import { getCharacterById } from '../../lib/content/characters';
import { getPlaceById } from '../../lib/content/places';
import { getPlanetById } from '../../lib/content/planets';
import { parseLocationRef } from '../../lib/content/location-refs';
import MarkdownDescription from '../../components/MarkdownDescription.astro';
import RelationList, { type RelationItem } from '../../components/RelationList.astro';
import Section from '../../components/Section.astro';

export async function getStaticPaths() {
  const events = await listEvents();
  return events.map((event) => ({
    params: { id: event.id },
  }));
}

const id = Astro.params.id;
const event = typeof id === 'string' ? await getEventById(id) : null;
const title = event ? event.title : 'Evento no encontrado';

type Participant = { id: string; name: string | null };

const participants: RelationItem[] = event
  ? (
      await Promise.all(
        event.who
          .map((participant) => participant.character)
          .filter((characterId) => characterId.length > 0)
          .map(async (characterId) => {
            const character = await getCharacterById(characterId);
            return {
              id: characterId,
              name: character ? character.name : null,
            };
          }),
      )
    ).filter(
      (participant, index, all) =>
        all.findIndex((entry) => entry.id === participant.id) === index,
    )
      .map((participant) => ({
        text: participant.name ?? `${participant.id} (no encontrado)`,
        href: participant.name ? `/characters/${participant.id}` : undefined,
      }))
  : [];

type LocationView = { text: string; href?: string };

const locations: LocationView[] = event
  ? (
      await Promise.all(
        event.locations.map(async (location) => {
          const parsed = parseLocationRef(location);
          if (!parsed) {
            return { text: 'Desconocido' };
          }
          switch (parsed.kind) {
            case 'place': {
              const place = await getPlaceById(parsed.id);
              if (!place) {
                return { text: `${parsed.id} (no encontrado)` };
              }
              return { text: place.name, href: `/places/${place.id}` };
            }
            case 'planet': {
              const planet = await getPlanetById(parsed.id);
              if (!planet) {
                return { text: `${parsed.id} (no encontrado)` };
              }
              return { text: planet.name, href: `/planets/${planet.id}` };
            }
            case 'space':
              return { text: parsed.id };
            case 'unknown':
              return { text: 'Desconocido' };
          }
        }),
      )
    ).filter((entry): entry is LocationView => Boolean(entry))
  : [];
---

<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width" />
    <title>{title}</title>
  </head>
  <body>
    <main>
      {event ? (
        <>
          <h1>{event.title}</h1>
          <p>{event.date}</p>
          <MarkdownDescription content={event.body} />
          <Section>
            <RelationList
              label="Participantes"
              items={participants}
              emptyText="Sin participantes."
            />
          </Section>
          <Section>
            <RelationList
              label="Ubicaciones"
              items={locations}
              emptyText="Sin ubicaciones."
            />
          </Section>
        </>
      ) : (
        <>
          <h1>Evento no encontrado</h1>
          <p>El evento solicitado no existe.</p>
          <p>
            <a href="/events">Volver a eventos</a>
          </p>
        </>
      )}
    </main>
  </body>
</html>
