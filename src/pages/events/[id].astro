---
import BaseLayout from '../../layouts/BaseLayout.astro';
import { getEventById, listEvents } from '../../lib/content/events';
import { getCharacterById } from '../../lib/content/characters';
import { getPlaceById } from '../../lib/content/places';
import { getPlanetById } from '../../lib/content/planets';
import { parseLocationRef } from '../../lib/content/location-refs';
import DataPanel, { type DataPanelItem } from '../../components/DataPanel.astro';
import EntityImage from '../../components/EntityImage.astro';
import Header from '../../components/Header.astro';
import type { BadgeVariant } from '../../components/Badge.astro';
import MarkdownDescription from '../../components/MarkdownDescription.astro';
import RelationList, { type RelationItem } from '../../components/RelationList.astro';
import Section from '../../components/Section.astro';

export async function getStaticPaths() {
  const events = await listEvents();
  return events.map((event) => ({
    params: { id: event.id },
  }));
}

const id = Astro.params.id;
const event = typeof id === 'string' ? await getEventById(id) : null;
const title = event ? event.title : 'Evento no encontrado';
const meta: Array<{ label: string; value: string; variant?: BadgeVariant }> = event
  ? [
      { label: 'Type', value: 'event', variant: 'muted' as BadgeVariant },
      { label: 'Id', value: event.id },
    ]
  : [];

type Participant = { id: string; name: string | null };
type LocationView = { text: string; href?: string; missing?: boolean };

const participants: RelationItem[] = event
  ? (
      await Promise.all(
        event.who
          .map((participant) => participant.character)
          .filter((characterId) => characterId.length > 0)
          .map(async (characterId) => {
            const character = await getCharacterById(characterId);
            return {
              id: characterId,
              name: character ? character.name : null,
            };
          }),
      )
    ).filter(
      (participant, index, all) =>
        all.findIndex((entry) => entry.id === participant.id) === index,
    )
      .map((participant) => ({
        text: participant.name ?? `${participant.id} (no encontrado)`,
        href: participant.name ? `/characters/${participant.id}` : undefined,
      }))
  : [];

const resolveLocationView = async (location: string): Promise<LocationView> => {
  const parsed = parseLocationRef(location);
  if (!parsed) {
    return { text: 'Desconocido' };
  }
  switch (parsed.kind) {
    case 'place': {
      const place = await getPlaceById(parsed.id);
      if (!place) {
        return { text: `${parsed.id} (no encontrado)`, missing: true };
      }
      return { text: place.name, href: `/places/${place.id}` };
    }
    case 'planet': {
      const planet = await getPlanetById(parsed.id);
      if (!planet) {
        return { text: `${parsed.id} (no encontrado)`, missing: true };
      }
      return { text: planet.name, href: `/planets/${planet.id}` };
    }
    case 'space':
      return { text: parsed.id };
    case 'unknown':
      return { text: 'Desconocido' };
  }
};

const locations: RelationItem[] = event
  ? (await Promise.all(event.locations.map(resolveLocationView))).map((item) => ({
      text: item.text,
      href: item.href,
      missing: item.missing,
    }))
  : [];

const originView =
  event && event.locations.length > 0
    ? await resolveLocationView(event.locations[0])
    : null;
const dataItems: DataPanelItem[] = [];

if (event?.date) {
  dataItems.push({ label: 'Fecha', value: event.date });
}

if (originView) {
  dataItems.push({
    label: 'Origen',
    value: originView.text,
    href: originView.href,
  });
}
---

<BaseLayout title={title} lang="en">
  {event ? (
    <div class="event-page">
      <div class="event-page__grid">
        <aside class="event-page__sidebar">
          {event.image ? <EntityImage src={event.image} alt={event.title} /> : null}
          <DataPanel title="Datos del evento" items={dataItems} />
        </aside>
        <div class="event-page__content">
          <Header title={event.title} meta={meta} icon="event" />
          <Section>
            <MarkdownDescription content={event.body} />
          </Section>
          <Section>
            <RelationList
              label="Participantes"
              items={participants}
              emptyText="Sin participantes."
            />
          </Section>
          <Section>
            <RelationList
              label="Ubicaciones"
              items={locations}
              emptyText="Sin ubicaciones."
            />
          </Section>
        </div>
      </div>
    </div>
  ) : (
    <>
      <Header title="Evento no encontrado" icon="event" />
      <Section>
        <p>El evento solicitado no existe.</p>
        <p>
          <a href="/events">Volver a eventos</a>
        </p>
      </Section>
    </>
  )}
</BaseLayout>
