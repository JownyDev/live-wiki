---
import BaseLayout from '../../layouts/BaseLayout.astro';
import Breadcrumbs, { type BreadcrumbItem } from '../../components/Breadcrumbs.astro';
import CharacterHero from '../../components/CharacterHero.astro';
import DataPanel, { type DataPanelItem } from '../../components/DataPanel.astro';
import MarkdownDescription from '../../components/MarkdownDescription.astro';
import RelationList, { type RelationItem } from '../../components/RelationList.astro';
import Section from '../../components/Section.astro';
import SectionHeader from '../../components/SectionHeader.astro';
import Tabs, { type TabItem } from '../../components/Tabs.astro';
import EntityList from '../../components/EntityList.astro';
import CharacterList, { type CharacterListItem } from '../../components/CharacterList.astro';
import { getEventById, listEvents } from '../../lib/content/events';
import { getCharacterById } from '../../lib/content/characters';
import { getPlaceById } from '../../lib/content/places';
import { getPlanetById } from '../../lib/content/planets';
import { parseLocationRef } from '../../lib/content/location-refs';
import { formatEntityId } from '../../lib/format';

export async function getStaticPaths() {
  const events = await listEvents();
  return events.map((event) => ({
    params: { id: event.id },
  }));
}

const id = Astro.params.id;
const event = typeof id === 'string' ? await getEventById(id) : null;
const title = event ? event.title : 'Evento no encontrado';

type LocationView = { text: string; href?: string; missing?: boolean };

const participants: CharacterListItem[] = event
  ? (
      await Promise.all(
        event.who
          .map((participant) => participant.character)
          .filter((characterId) => characterId.length > 0)
          .map(async (characterId) => {
            const character = await getCharacterById(characterId);
            if (!character) {
                return {
                    id: characterId,
                    name: `${characterId} (no encontrado)`,
                };
            }
            return {
              id: character.id,
              name: character.name,
              image: character.image,
              archetype: character.persona?.archetype ?? undefined,
              origin: character.origin,
              href: `/characters/${character.id}`
            };
          }),
      )
    ).filter(
      (participant, index, all) =>
        all.findIndex((entry) => entry.id === participant.id) === index,
    )
  : [];

const resolveLocationView = async (location: string): Promise<LocationView> => {
  const parsed = parseLocationRef(location);
  if (!parsed) {
    return { text: 'Desconocido' };
  }
  switch (parsed.kind) {
    case 'place': {
      const place = await getPlaceById(parsed.id);
      if (!place) {
        return { text: `${formatEntityId(parsed.id)} (no encontrado)`, missing: true };
      }
      return { text: place.name, href: `/places/${parsed.id}` };
    }
    case 'planet': {
      const planet = await getPlanetById(parsed.id);
      if (!planet) {
        return { text: `${formatEntityId(parsed.id)} (no encontrado)`, missing: true };
      }
      return { text: planet.name, href: `/planets/${parsed.id}` };
    }
    case 'space':
      return { text: formatEntityId(parsed.id) };
    case 'unknown':
      return { text: 'Desconocido' };
  }
};

const locations: RelationItem[] = event
  ? (await Promise.all(event.locations.map(resolveLocationView))).map((item) => ({
      text: item.text,
      href: item.href,
      missing: item.missing,
    }))
  : [];

const breadcrumbs: BreadcrumbItem[] = event
  ? [
      { label: 'Inicio', href: '/' },
      { label: 'Eventos', href: '/events' },
      { label: event.title, current: true },
    ]
  : [
      { label: 'Inicio', href: '/' },
      { label: 'Eventos', href: '/events' },
      { label: 'Evento no encontrado', current: true },
    ];

const eventMeta = event ? [{ label: 'ID', value: `#${event.id}` }] : [];

const dataItems: DataPanelItem[] = [];
if (event?.date) {
  dataItems.push({ label: 'Fecha', value: event.date, icon: 'calendar_today' });
}

const tabItems: TabItem[] = [
  { id: 'description', label: 'Descripción', icon: 'description' },
  { id: 'participants', label: 'Participantes', icon: 'group' },
  { id: 'locations', label: 'Ubicaciones', icon: 'location_on' },
];

const locationItems = locations.map(l => ({
  label: l.text,
  href: l.href
}));
---

<BaseLayout title={title} lang="es">
  {event ? (
    <div class="event-page">
      <Breadcrumbs items={breadcrumbs} />
      <CharacterHero
        name={event.title}
        meta={eventMeta}
        imageUrl={event.image ?? undefined}
      />

      <div class="event-page__grid">
        <aside class="event-page__sidebar">
          <DataPanel title="Detalles del evento" items={dataItems} />
        </aside>

        <div class="event-page__content">
          <Tabs items={tabItems} defaultTab="description">
            <div data-tab-panel="description" class="animate-fadeIn">
              <Section>
                <SectionHeader title="Crónica" showDivider />
                <MarkdownDescription content={event.body} />
              </Section>
            </div>

            <div data-tab-panel="participants" class="animate-fadeIn" hidden>
              <Section>
                <SectionHeader title="Personajes involucrados" showDivider />
                {participants.length === 0 ? (
                  <p>No hay participantes registrados.</p>
                ) : (
                  <CharacterList characters={participants} />
                )}
              </Section>
            </div>

            <div data-tab-panel="locations" class="animate-fadeIn" hidden>
              <Section>
                <SectionHeader title="Localizaciones" showDivider />
                {locations.length === 0 ? (
                  <p>No hay ubicaciones registradas.</p>
                ) : (
                  <EntityList items={locationItems} />
                )}
              </Section>
            </div>
          </Tabs>
        </div>
      </div>
    </div>
  ) : (
    <div class="event-page">
      <Breadcrumbs items={breadcrumbs} />
      <CharacterHero name="Evento no encontrado" />
      <Section>
        <p>El evento solicitado no existe.</p>
        <p>
          <a href="/events">Volver a eventos</a>
        </p>
      </Section>
    </div>
  )}
</BaseLayout>
