---
import BaseLayout from '../../layouts/BaseLayout.astro';
import Header from '../../components/Header.astro';
import MarkdownDescription from '../../components/MarkdownDescription.astro';
import RelationList, { type RelationItem } from '../../components/RelationList.astro';
import Section from '../../components/Section.astro';
import EntityLink from '../../components/EntityLink.astro';
import { getPlaceById, listPlaces } from '../../lib/content/places';
import { listEventsByPlaceId } from '../../lib/content/events';

export async function getStaticPaths() {
  const places = await listPlaces();
  return places.map((place) => ({
    params: { id: place.id },
  }));
}

const id = Astro.params.id;
const place = typeof id === 'string' ? await getPlaceById(id) : null;
const events =
  place && typeof id === 'string' ? await listEventsByPlaceId(id) : [];
const eventItems: RelationItem[] = events.map((event) => ({
  text: `${event.title} (${event.date})`,
  href: `/events/${event.id}`,
}));
const title = place ? place.name : 'Lugar no encontrado';
const planetLabel = (() => {
  if (!place) {
    return 'Desconocido';
  }
  if (place.planetId) {
    return { text: place.planetId, href: `/planets/${place.planetId}` };
  }
  if (place.locationType === 'space') {
    return 'Espacio';
  }
  if (place.locationType === 'planet') {
    return 'Planeta';
  }
  if (place.locationType === 'unknown') {
    return 'Desconocido';
  }
  return 'Desconocido';
})();
---

<BaseLayout title={title}>
  {place ? (
    <>
      <Header title={place.name} icon="place" />
      <Section title="Planeta">
        {typeof planetLabel === 'string' ? (
          <p>{planetLabel}</p>
        ) : (
          <EntityLink href={planetLabel.href} label={planetLabel.text} />
        )}
      </Section>
      <Section>
        <RelationList label="Eventos aqui" items={eventItems} emptyText="Sin eventos." />
      </Section>
      <MarkdownDescription content={place.body} />
    </>
  ) : (
    <>
      <Header title="Lugar no encontrado" icon="place" />
      <Section>
        <p>El lugar solicitado no existe.</p>
        <p>
          <a href="/places">Volver a lugares</a>
        </p>
      </Section>
    </>
  )}
</BaseLayout>
