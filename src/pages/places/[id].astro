---
import BaseLayout from '../../layouts/BaseLayout.astro';
import Breadcrumbs, { type BreadcrumbItem } from '../../components/Breadcrumbs.astro';
import CharacterHero from '../../components/CharacterHero.astro';
import DataPanel, { type DataPanelItem } from '../../components/DataPanel.astro';
import EventSummaryCard from '../../components/EventSummaryCard.astro';
import MarkdownDescription from '../../components/MarkdownDescription.astro';
import Section from '../../components/Section.astro';
import SectionHeader from '../../components/SectionHeader.astro';
import Tabs, { type TabItem } from '../../components/Tabs.astro';
import { getPlaceById, listPlaces } from '../../lib/content/places';
import { getPlanetById } from '../../lib/content/planets';
import { listEventsByPlaceId } from '../../lib/content/events';

export async function getStaticPaths() {
  const places = await listPlaces();
  return places.map((place) => ({
    params: { id: place.id },
  }));
}

const id = Astro.params.id;
const place = typeof id === 'string' ? await getPlaceById(id) : null;
const events =
  place && typeof id === 'string' ? await listEventsByPlaceId(id) : [];

const planet = place?.planetId ? await getPlanetById(place.planetId) : null;

const title = place ? place.name : 'Lugar no encontrado';

const breadcrumbs: BreadcrumbItem[] = place
  ? [
      { label: 'Inicio', href: '/' },
      { label: 'Lugares', href: '/places' },
      { label: place.name, current: true },
    ]
  : [
      { label: 'Inicio', href: '/' },
      { label: 'Lugares', href: '/places' },
      { label: 'Lugar no encontrado', current: true },
    ];

const placeMeta = place ? [{ label: 'ID', value: `#${place.id}` }] : [];

const dataItems: DataPanelItem[] = [];
if (place) {
  if (planet) {
    dataItems.push({
      label: 'Planeta',
      value: planet.name,
      href: `/planets/${planet.id}`,
      icon: 'public',
    });
  } else if (place.planetId) {
    dataItems.push({
      label: 'Planeta',
      value: place.planetId,
      href: `/planets/${place.planetId}`,
      icon: 'public',
    });
  }

  if (place.locationType) {
    const typeLabels = {
      space: 'Espacio Exterior',
      planet: 'Superficie Planetaria',
      unknown: 'Desconocido',
    };
    dataItems.push({
      label: 'Tipo de Ubicaci贸n',
      value: typeLabels[place.locationType],
      icon: 'category',
    });
  }
}

const tabItems: TabItem[] = [
  { id: 'info', label: 'Informaci贸n', icon: 'description' },
  { id: 'events', label: 'Eventos', icon: 'event' },
];
---

<BaseLayout title={title} lang="es">
  {place ? (
    <div class="character-page">
      <Breadcrumbs items={breadcrumbs} />
      <CharacterHero
        name={place.name}
        meta={placeMeta}
        imageUrl={place.image}
      />

      <div class="character-page__grid">
        <aside class="character-page__sidebar">
          <DataPanel title="Datos del lugar" items={dataItems} />
        </aside>

        <div class="character-page__content">
          <Tabs items={tabItems} defaultTab="info">
            <div data-tab-panel="info" class="animate-fadeIn">
              <Section>
                <SectionHeader title="Descripci贸n" showDivider />
                <MarkdownDescription content={place.body} />
              </Section>
            </div>

            <div data-tab-panel="events" class="animate-fadeIn" hidden>
              <Section>
                <SectionHeader title="Eventos en este lugar" showDivider />
                {events.length === 0 ? (
                  <p>No hay eventos registrados en esta ubicaci贸n.</p>
                ) : (
                  <div class="relative space-y-16 py-8 before:content-[''] before:absolute before:left-1/2 before:top-0 before:-translate-x-1/2 before:w-px before:h-full before:bg-gradient-to-b before:from-transparent before:via-accent before:to-transparent before:opacity-30">
                    {events.map((event, index) => (
                      <EventSummaryCard
                        title={event.title}
                        date={event.date}
                        preview={event.preview}
                        href={`/events/${event.id}`}
                        side={index % 2 === 0 ? 'right' : 'left'}
                      />
                    ))}
                  </div>
                )}
              </Section>
            </div>
          </Tabs>
        </div>
      </div>
    </div>
  ) : (
    <div class="character-page">
      <Breadcrumbs items={breadcrumbs} />
      <CharacterHero name="Lugar no encontrado" />
      <Section>
        <p>El lugar solicitado no existe.</p>
        <p>
          <a href="/places">Volver a lugares</a>
        </p>
      </Section>
    </div>
  )}
</BaseLayout>