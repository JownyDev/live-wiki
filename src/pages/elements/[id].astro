---
import BaseLayout from '../../layouts/BaseLayout.astro';
import DataPanel, { type DataPanelItem } from '../../components/DataPanel.astro';
import EntityImage from '../../components/EntityImage.astro';
import Header from '../../components/Header.astro';
import MarkdownDescription from '../../components/MarkdownDescription.astro';
import Section from '../../components/Section.astro';
import { getElementById, listElements } from '../../lib/content/elements';
import { getPlaceById } from '../../lib/content/places';
import { getPlanetById } from '../../lib/content/planets';
import { parseLocationRef } from '../../lib/content/location-refs';
import { formatEntityId } from '../../lib/format';

export async function getStaticPaths() {
  const elements = await listElements();
  return elements.map((element) => ({
    params: { id: element.id },
  }));
}

const id = Astro.params.id;
const element = typeof id === 'string' ? await getElementById(id) : null;
const title = element ? element.name : 'Elemento no encontrado';
const originView = await (async () => {
  if (!element?.origin) {
    return null;
  }
  const parsed = parseLocationRef(element.origin);
  if (!parsed) {
    return null;
  }
  switch (parsed.kind) {
    case 'place': {
      const place = await getPlaceById(parsed.id);
      return { text: place?.name ?? formatEntityId(parsed.id), href: `/places/${parsed.id}` };
    }
    case 'planet': {
      const planet = await getPlanetById(parsed.id);
      return { text: planet?.name ?? formatEntityId(parsed.id), href: `/planets/${parsed.id}` };
    }
    case 'space':
      return { text: formatEntityId(parsed.id) };
    case 'unknown':
      return { text: 'Desconocido' };
  }
})();
const dataItems: DataPanelItem[] = [];

if (originView) {
  dataItems.push({ label: 'Origen', value: originView.text, href: originView.href });
}
---

<BaseLayout title={title}>
  {element ? (
    <div class="element-page">
      <div class="element-page__grid">
        <aside class="element-page__sidebar">
          {element.image ? (
            <EntityImage src={element.image} alt={element.name} />
          ) : null}
          <DataPanel title="Datos del elemento" items={dataItems} />
        </aside>
        <div class="element-page__content">
          <Header title={element.name} icon="auto_awesome" />
          <Section>
            <MarkdownDescription content={element.body} />
          </Section>
        </div>
      </div>
    </div>
  ) : (
    <>
      <Header title="Elemento no encontrado" icon="auto_awesome" />
      <Section>
        <p>El elemento solicitado no existe.</p>
        <p>
          <a href="/elements">Volver a elementos</a>
        </p>
      </Section>
    </>
  )}
</BaseLayout>
