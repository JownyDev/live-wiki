---
import BaseLayout from '../../layouts/BaseLayout.astro';
import Breadcrumbs, { type BreadcrumbItem } from '../../components/Breadcrumbs.astro';
import CharacterHero from '../../components/CharacterHero.astro';
import DataPanel, { type DataPanelItem } from '../../components/DataPanel.astro';
import MarkdownDescription from '../../components/MarkdownDescription.astro';
import Section from '../../components/Section.astro';
import SectionHeader from '../../components/SectionHeader.astro';
import Tabs, { type TabItem } from '../../components/Tabs.astro';
import { getElementById, listElements } from '../../lib/content/elements';
import { getPlaceById } from '../../lib/content/places';
import { getPlanetById } from '../../lib/content/planets';
import { parseLocationRef } from '../../lib/content/location-refs';
import { formatEntityId } from '../../lib/format';

export async function getStaticPaths() {
  const elements = await listElements();
  return elements.map((element) => ({
    params: { id: element.id },
  }));
}

const id = Astro.params.id;
const element = typeof id === 'string' ? await getElementById(id) : null;
const title = element ? element.name : 'Elemento no encontrado';

const originView = await (async () => {
  if (!element?.origin) {
    return null;
  }
  const parsed = parseLocationRef(element.origin);
  if (!parsed) {
    return null;
  }
  switch (parsed.kind) {
    case 'place': {
      const place = await getPlaceById(parsed.id);
      return { text: place?.name ?? formatEntityId(parsed.id), href: `/places/${parsed.id}` };
    }
    case 'planet': {
      const planet = await getPlanetById(parsed.id);
      return { text: planet?.name ?? formatEntityId(parsed.id), href: `/planets/${parsed.id}` };
    }
    case 'space':
      return { text: formatEntityId(parsed.id) };
    case 'unknown':
      return { text: 'Desconocido' };
  }
})();

const breadcrumbs: BreadcrumbItem[] = element
  ? [
      { label: 'Inicio', href: '/' },
      { label: 'Elementos', href: '/elements' },
      { label: element.name, current: true },
    ]
  : [
      { label: 'Inicio', href: '/' },
      { label: 'Elementos', href: '/elements' },
      { label: 'Elemento no encontrado', current: true },
    ];

const elementMeta = element ? [{ label: 'ID', value: `#${element.id}` }] : [];

const dataItems: DataPanelItem[] = [];
if (originView) {
  dataItems.push({ 
    label: 'Origen Primario', 
    value: originView.text, 
    href: originView.href,
    icon: 'location_on' 
  });
}

const tabItems: TabItem[] = [
  { id: 'info', label: 'Informaci√≥n', icon: 'description' },
];
---

<BaseLayout title={title} lang="es">
  {element ? (
    <div class="element-page">
      <Breadcrumbs items={breadcrumbs} />
      <CharacterHero
        name={element.name}
        meta={elementMeta}
        imageUrl={element.image ?? undefined}
      />

      <div class="element-page__grid">
        <aside class="element-page__sidebar">
          <DataPanel title="Datos del elemento" items={dataItems} />
        </aside>

        <div class="element-page__content">
          <Tabs items={tabItems} defaultTab="info">
            <div data-tab-panel="info" class="animate-fadeIn">
              <Section>
                <SectionHeader title="Esencia y Propiedades" showDivider />
                <MarkdownDescription content={element.body} />
              </Section>
            </div>
          </Tabs>
        </div>
      </div>
    </div>
  ) : (
    <div class="element-page">
      <Breadcrumbs items={breadcrumbs} />
      <CharacterHero name="Elemento no encontrado" />
      <Section>
        <p>El elemento solicitado no existe.</p>
        <p>
          <a href="/elements">Volver a elementos</a>
        </p>
      </Section>
    </div>
  )}
</BaseLayout>