---
import { getLangFromUrl, useTranslations } from '../i18n/utils';

const lang = getLangFromUrl(Astro.url);
const t = useTranslations(lang);

type Manipulability = {
  byEmpathy: string | null;
  byBribe: string | null;
  byIntimidation: string | null;
  byAuthority: string | null;
  notes: string[];
};

type Props = {
  angersIf?: string[];
  calmsIf?: string[];
  manipulability?: Manipulability | null;
};

const { angersIf = [], calmsIf = [], manipulability = null } = Astro.props as Props;
const hasAngers = angersIf.length > 0;
const hasCalms = calmsIf.length > 0;
type FactorTone = 'high' | 'medium' | 'low' | 'unknown';

const hasText = (value: string | null | undefined): value is string =>
  typeof value === 'string' && value.trim().length > 0;

const getFactorTone = (value: string): FactorTone => {
  const normalized = value
    .trim()
    .toLowerCase()
    .normalize('NFD')
    .replace(/[\u0300-\u036f]/g, '');
  const toneMap: Record<string, FactorTone> = {
    high: 'high',
    alta: 'high',
    medium: 'medium',
    media: 'medium',
    low: 'low',
    baja: 'low',
  };
  return toneMap[normalized] ?? 'unknown';
};

const factors = manipulability
  ? [
      { label: t('ui.empathy'), value: manipulability.byEmpathy },
      { label: t('ui.bribe'), value: manipulability.byBribe },
      { label: t('ui.intimidation'), value: manipulability.byIntimidation },
      { label: t('ui.authority'), value: manipulability.byAuthority },
    ]
      .filter((factor) => hasText(factor.value))
      .map((factor) => ({
        label: factor.label,
        value: factor.value,
        tone: getFactorTone(factor.value),
      }))
  : [];
const notes = manipulability?.notes ?? [];
const hasNotes = notes.length > 0;
---

<div class="emotions-sensitivity">
  <h3 class="emotions-sensitivity__title">
    <span class="material-symbols-outlined emotions-sensitivity__icon" aria-hidden="true">
      psychology
    </span>
    {t('ui.sens_manip')}
  </h3>
  <div class="emotions-sensitivity__grid">
    {hasAngers ? (
      <div class="emotions-sensitivity__block">
        <div class="emotions-sensitivity__heading emotions-sensitivity__heading--anger">
          <span
            class="material-symbols-outlined emotions-sensitivity__heading-icon"
            aria-hidden="true"
          >
            warning
          </span>
          {t('ui.angers_if')}
        </div>
        <ul class="emotions-sensitivity__list">
          {angersIf.map((item) => (
            <li class="emotions-sensitivity__item emotions-sensitivity__item--anger">
              <span class="emotions-sensitivity__dot emotions-sensitivity__dot--anger"></span>
              {item}
            </li>
          ))}
        </ul>
      </div>
    ) : null}
    {hasCalms ? (
      <div class="emotions-sensitivity__block">
        <div class="emotions-sensitivity__heading emotions-sensitivity__heading--calm">
          <span
            class="material-symbols-outlined emotions-sensitivity__heading-icon"
            aria-hidden="true"
          >
            check_circle
          </span>
          {t('ui.calms_if')}
        </div>
        <ul class="emotions-sensitivity__list">
          {calmsIf.map((item) => (
            <li class="emotions-sensitivity__item emotions-sensitivity__item--calm">
              <span class="emotions-sensitivity__dot emotions-sensitivity__dot--calm"></span>
              {item}
            </li>
          ))}
        </ul>
      </div>
    ) : null}
  </div>
  {factors.length > 0 ? (
    <div class="emotions-sensitivity__manipulability">
      <span class="emotions-sensitivity__caption">{t('ui.manip_factors')}</span>
      <div class="emotions-sensitivity__factors tag-list">
        {factors.map((factor) => (
          <div class="emotions-sensitivity__factor">
            <span class="emotions-sensitivity__factor-label">{factor.label}:</span>
            <span
              class:list={[
                "emotions-sensitivity__factor-value",
                factor.tone !== 'unknown' && `emotions-sensitivity__factor-value--${factor.tone}`
              ]}
            >
              {String(factor.value).toUpperCase()}
            </span>
          </div>
        ))}
      </div>
      {hasNotes ? (
        <div class="emotions-sensitivity__notes">
          <span
            class="material-symbols-outlined emotions-sensitivity__notes-icon"
            aria-hidden="true"
          >
            info
          </span>
          <div class="emotions-sensitivity__notes-text">
            {notes.map((note) => (
              <p class="m-0">{note}</p>
            ))}
          </div>
        </div>
      ) : null}
    </div>
  ) : null}
</div>