---
import EntityLink from './EntityLink.astro';
import { getLangFromUrl, useTranslations } from '../i18n/utils';
import { getRelativeLocaleUrl } from 'astro:i18n';

const lang = getLangFromUrl(Astro.url);
const t = useTranslations(lang);

type NavItem = {
  href: string;
  label: string;
  icon: string;
};

const items: NavItem[] = [
  { href: getRelativeLocaleUrl(lang, '/characters'), label: t('nav.characters'), icon: 'group' },
  { href: getRelativeLocaleUrl(lang, '/events'), label: t('nav.events'), icon: 'event' },
  { href: getRelativeLocaleUrl(lang, '/places'), label: t('nav.places'), icon: 'place' },
  { href: getRelativeLocaleUrl(lang, '/planets'), label: t('nav.planets'), icon: 'public' },
  { href: getRelativeLocaleUrl(lang, '/elements'), label: t('nav.elements'), icon: 'auto_awesome' },
  { href: getRelativeLocaleUrl(lang, '/cards'), label: t('nav.cards'), icon: 'style' },
  { href: getRelativeLocaleUrl(lang, '/mechanics'), label: t('nav.mechanics'), icon: 'tune' },
];

const { pathname } = Astro.url;
// Normalize pathname to ensure leading slash and handle potential trailing slashes
const normalizedPath = pathname.replace(/\/$/, '') || '/';

const isActive = (href: string) => {
  if (href === '/') return normalizedPath === '/';
  // Check if current path starts with href (e.g. /characters/mira-lane matches /characters)
  return normalizedPath.startsWith(href);
};
---

<nav class="primary-nav flex items-center" aria-label={t("ui.nav_label")}>
  {/* Desktop Menu */}
  <ul class="primary-nav__list hidden xl:flex items-center gap-x-space-3 gap-y-space-2 list-none m-0 p-0 text-[0.85rem] whitespace-nowrap">
    {items.map((item) => {
      const active = isActive(item.href);
      return (
        <li>
          <EntityLink 
            href={item.href} 
            label={item.label} 
            icon={item.icon} 
            className={active ? '!text-accent font-bold border-b-2 border-accent pb-1' : ''} 
          />
        </li>
      );
    })}
  </ul>

  {/* Mobile Hamburger Button */}
  <button 
    id="mobile-menu-toggle" 
    class="xl:hidden p-2 text-muted hover:text-text focus:outline-none rounded-md transition-colors"
    aria-label={t("ui.open_menu")}
    aria-expanded="false"
    aria-controls="mobile-menu"
  >
    <span class="material-symbols-outlined text-2xl">menu</span>
  </button>

  {/* Mobile Menu Overlay */}
  <div 
    id="mobile-menu" 
    class="fixed inset-0 top-[60px] bg-bg z-50 flex flex-col p-6 overflow-y-auto border-t border-border opacity-0 invisible transition-all duration-300 ease-in-out"
  >
    <ul class="flex flex-col gap-6 text-[1.1rem]">
      {items.map((item) => {
        const active = isActive(item.href);
        return (
          <li>
            <EntityLink 
              href={item.href} 
              label={item.label} 
              icon={item.icon} 
              className={`flex items-center gap-3 ${active ? '!text-accent font-bold' : 'text-text'}`}
              iconClassName="text-[1.3rem]"
            />
          </li>
        );
      })}
    </ul>
  </div>
</nav>

<script>
  const toggleBtn = document.getElementById('mobile-menu-toggle');
  const mobileMenu = document.getElementById('mobile-menu');
  const icon = toggleBtn?.querySelector('.material-symbols-outlined');

  if (toggleBtn && mobileMenu && icon) {
    toggleBtn.addEventListener('click', () => {
      const isExpanded = toggleBtn.getAttribute('aria-expanded') === 'true';
      toggleBtn.setAttribute('aria-expanded', (!isExpanded).toString());
      
      // Toggle visibility classes
      mobileMenu.classList.toggle('opacity-0');
      mobileMenu.classList.toggle('invisible');
      mobileMenu.classList.toggle('opacity-100');
      mobileMenu.classList.toggle('visible');
      
      // Toggle button active state
      toggleBtn.classList.toggle('bg-surface-muted');
      toggleBtn.classList.toggle('text-accent');
      
      // Toggle icon
      icon.textContent = isExpanded ? 'menu' : 'close';
      
      // Prevent body scroll when menu is open
      document.body.style.overflow = isExpanded ? '' : 'hidden';
    });
  }
</script>
